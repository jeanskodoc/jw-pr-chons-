<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pr√™chons - Application de Suivi des Pr√©dications</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(to right, #2c3e50, #4a6491);
            color: white;
            padding: 25px 30px;
            text-align: center;
            position: relative;
        }
        
        h1 {
            font-size: 2.4rem;
            margin-bottom: 8px;
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .jw-logo {
            font-family: 'Arial', sans-serif;
            font-weight: bold;
            font-size: 3.2rem;
            color: #ffffff;
            background-color: #d4a017;
            width: 80px;
            height: 80px;
            line-height: 80px;
            border-radius: 50%;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }
        
        .jw-logo::before {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            border: 2px solid rgba(212, 160, 23, 0.4);
            border-radius: 50%;
        }
        
        .jw-logo span {
            font-size: 2.5rem;
            letter-spacing: -2px;
        }
        
        .tabs-container {
            display: flex;
            background-color: #f1f5f9;
            border-bottom: 1px solid #ddd;
            overflow-x: auto;
        }
        
        .tab {
            padding: 18px 20px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            color: #64748b;
            white-space: nowrap;
            min-width: 140px;
        }
        
        .tab:hover {
            background-color: #e2e8f0;
            color: #475569;
        }
        
        .tab.active {
            background-color: white;
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
        }
        
        .tab-content {
            display: none;
            padding: 30px;
            animation: fadeIn 0.5s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 25px;
            gap: 20px;
        }
        
        .form-group {
            flex: 1;
            min-width: 250px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .label-jw-icon {
            font-family: 'Arial', sans-serif;
            font-weight: bold;
            color: #d4a017;
            background-color: #fef9e7;
            padding: 4px 10px;
            border-radius: 4px;
            border: 1px solid #f9e79f;
            font-size: 0.9em;
            letter-spacing: -0.5px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        .gps-coordinates {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-top: 5px;
            font-family: monospace;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .gps-status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            margin-left: 10px;
        }
        
        .gps-status.active {
            background-color: #27ae60;
            color: white;
        }
        
        .gps-status.inactive {
            background-color: #e74c3c;
            color: white;
        }
        
        .action-buttons {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 40px;
            padding-top: 25px;
            border-top: 1px solid #eee;
        }
        
        .btn {
            padding: 14px 25px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 180px;
        }
        
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background-color: #27ae60;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #219653;
            transform: translateY(-2px);
        }
        
        .btn-whatsapp {
            background-color: #25D366;
            color: white;
        }
        
        .btn-whatsapp:hover {
            background-color: #1da851;
            transform: translateY(-2px);
        }
        
        .btn-import {
            background-color: #f39c12;
            color: white;
        }
        
        .btn-import:hover {
            background-color: #d68910;
            transform: translateY(-2px);
        }
        
        .btn-export {
            background-color: #9b59b6;
            color: white;
        }
        
        .btn-export:hover {
            background-color: #8e44ad;
            transform: translateY(-2px);
        }
        
        .btn-search {
            background-color: #e74c3c;
            color: white;
        }
        
        .btn-search:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
        }
        
        .btn-gps {
            background-color: #2c3e50;
            color: white;
        }
        
        .btn-gps:hover {
            background-color: #1a252f;
            transform: translateY(-2px);
        }
        
        .btn-map {
            background-color: #e74c3c;
            color: white;
        }
        
        .btn-map:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
        }
        
        .btn-position {
            background-color: #3498db;
            color: white;
        }
        
        .btn-position:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }
        
        .btn i {
            font-size: 1.2rem;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            margin-top: 20px;
            color: #7f8c8d;
            font-size: 0.9rem;
            border-top: 1px solid #eee;
        }
        
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            background-color: #2ecc71;
            color: white;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: none;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .jw-decoration {
            position: absolute;
            opacity: 0.15;
            font-family: 'Arial', sans-serif;
            font-weight: bold;
            font-size: 4rem;
            color: white;
        }
        
        .jw-decoration.left {
            top: 20px;
            left: 30px;
        }
        
        .jw-decoration.right {
            bottom: 20px;
            right: 30px;
        }
        
        .list-content {
            padding: 20px;
        }
        
        .list-item {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #3498db;
            transition: transform 0.2s;
        }
        
        .list-item:hover {
            transform: translateX(5px);
            background-color: #f1f5f9;
        }
        
        .list-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .list-date {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .list-location {
            color: #64748b;
        }
        
        .list-group {
            display: inline-block;
            background-color: #e2e8f0;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        .empty-list {
            text-align: center;
            padding: 50px 20px;
            color: #94a3b8;
        }
        
        .empty-list i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #cbd5e1;
        }
        
        /* Styles pour le cahier d'activit√© */
        .activity-form {
            background-color: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            border: 1px solid #e2e8f0;
        }
        
        .activity-item {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #9b59b6;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .activity-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            align-items: flex-start;
        }
        
        .activity-person {
            font-weight: bold;
            color: #2c3e50;
            font-size: 1.1rem;
        }
        
        .activity-date {
            color: #64748b;
            font-size: 0.9rem;
            background-color: #e2e8f0;
            padding: 4px 10px;
            border-radius: 15px;
        }
        
        .activity-theme {
            color: #2c3e50;
            margin: 8px 0;
            font-weight: 600;
        }
        
        .activity-verse {
            color: #27ae60;
            margin: 8px 0;
            font-style: italic;
        }
        
        .activity-suspended {
            color: #e74c3c;
            margin: 8px 0;
            font-weight: 600;
        }
        
        .activity-next-visit {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #ddd;
            color: #3498db;
            display: flex;
            justify-content: space-between;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .status-pending {
            background-color: #fef3c7;
            color: #d97706;
        }
        
        .status-completed {
            background-color: #d1fae5;
            color: #059669;
        }
        
        .activity-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .activity-actions button {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn-edit {
            background-color: #3498db;
            color: white;
        }
        
        .btn-delete {
            background-color: #e74c3c;
            color: white;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .stat-card {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #2c3e50;
        }
        
        /* Styles pour l'√©diteur enrichi */
        .rich-editor-container {
            border: 1px solid #ddd;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .rich-editor-toolbar {
            background-color: #f8f9fa;
            padding: 10px;
            border-bottom: 1px solid #ddd;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .rich-editor-toolbar button {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .rich-editor-toolbar button:hover {
            background-color: #f1f5f9;
            border-color: #3498db;
        }
        
        .rich-editor-toolbar button.active {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        .rich-editor-content {
            min-height: 150px;
            padding: 15px;
            font-size: 16px;
            line-height: 1.6;
            outline: none;
            overflow-y: auto;
            max-height: 300px;
        }
        
        .rich-editor-content:empty:before {
            content: attr(data-placeholder);
            color: #94a3b8;
        }
        
        .rich-editor-content h1, .rich-editor-content h2, .rich-editor-content h3 {
            margin: 10px 0;
            color: #2c3e50;
        }
        
        .rich-editor-content ul, .rich-editor-content ol {
            padding-left: 20px;
            margin: 10px 0;
        }
        
        .rich-editor-content blockquote {
            border-left: 4px solid #3498db;
            padding-left: 15px;
            margin: 10px 0;
            color: #64748b;
            font-style: italic;
        }
        
        .search-section {
            background-color: #fef3c7;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            border: 1px solid #fbbf24;
        }
        
        .search-section h4 {
            color: #d97706;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .search-input-group {
            display: flex;
            gap: 10px;
        }
        
        .search-input-group input {
            flex: 1;
        }
        
        .search-input-group button {
            padding: 12px 20px;
            white-space: nowrap;
        }
        
        .predefined-searches {
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .predefined-searches button {
            background-color: white;
            border: 1px solid #fbbf24;
            color: #d97706;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .predefined-searches button:hover {
            background-color: #fef3c7;
            border-color: #d97706;
        }
        
        /* Section GPS pour le cahier d'activit√© */
        .gps-section {
            background-color: #e8f4fc;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            border: 1px solid #3498db;
        }
        
        .gps-section h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .gps-info {
            background-color: white;
            padding: 15px;
            border-radius: 6px;
            margin-top: 10px;
            font-family: monospace;
            border: 1px solid #ddd;
        }
        
        .gps-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .gps-buttons button {
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }
        
        .address-info {
            background-color: #f0f9ff;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            border: 1px solid #bae6fd;
            display: none;
        }
        
        .address-info.show {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        .address-line {
            margin: 5px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .coordinates-display {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }
        
        .coordinate-item {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            flex: 1;
        }
        
        /* Styles pour l'ic√¥ne JW dans les statistiques */
        .jw-stat-icon {
            font-family: 'Arial', sans-serif;
            font-weight: bold;
            font-size: 2.2rem;
            color: #ffffff;
            background-color: #d4a017;
            width: 70px;
            height: 70px;
            line-height: 70px;
            border-radius: 50%;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
        }
        
        .jw-stat-icon span {
            font-size: 1.8rem;
            letter-spacing: -1px;
        }
        
        /* Styles pour l'ic√¥ne JW dans le formulaire RDV */
        .jw-form-icon {
            font-family: 'Arial', sans-serif;
            font-weight: bold;
            color: #d4a017;
            background-color: #fef9e7;
            padding: 6px 12px;
            border-radius: 4px;
            border: 1px solid #f9e79f;
            font-size: 0.95em;
            letter-spacing: -0.5px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 40px;
        }
        
        .text-area-with-jw {
            position: relative;
        }
        
        .jw-textarea-label {
            position: absolute;
            top: -10px;
            left: 15px;
            background-color: white;
            padding: 0 8px;
            font-size: 0.9rem;
            color: #d4a017;
            font-weight: 600;
            z-index: 1;
        }
        
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }
            
            .form-group {
                min-width: 100%;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .jw-decoration {
                display: none;
            }
            
            .jw-logo {
                width: 70px;
                height: 70px;
                line-height: 70px;
                font-size: 2.8rem;
            }
            
            .jw-logo span {
                font-size: 2.2rem;
            }
            
            .tabs-container {
                flex-direction: column;
            }
            
            .tab {
                padding: 15px;
                min-width: auto;
            }
            
            .activity-item-header {
                flex-direction: column;
                gap: 10px;
            }
            
            .activity-next-visit {
                flex-direction: column;
                gap: 5px;
            }
            
            .search-input-group {
                flex-direction: column;
            }
            
            .search-input-group button {
                width: 100%;
            }
            
            .rich-editor-toolbar {
                justify-content: center;
            }
            
            .gps-buttons {
                flex-direction: column;
            }
            
            .coordinates-display {
                flex-direction: column;
            }
            
            .jw-stat-icon {
                width: 60px;
                height: 60px;
                line-height: 60px;
                font-size: 1.8rem;
            }
            
            .jw-stat-icon span {
                font-size: 1.5rem;
            }
            
            .jw-form-icon {
                padding: 4px 8px;
                font-size: 0.85em;
                min-width: 35px;
            }
        }
        
        /* Nouveaux styles pour l'√©dition des items import√©s */
        .edit-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: flex-end;
        }
        
        .btn-save-edit {
            background-color: #27ae60;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn-cancel-edit {
            background-color: #7f8c8d;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn-load-form {
            background-color: #9b59b6;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .list-item.editing {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
        }
        
        .list-item.editing .edit-form {
            display: block;
        }
        
        .edit-form {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
        }
        
        .edit-form .form-row {
            margin-bottom: 15px;
        }
        
        .edit-form input,
        .edit-form select,
        .edit-form textarea {
            padding: 10px;
            font-size: 14px;
        }
        
        .imported-badge {
            display: inline-block;
            background-color: #f39c12;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-left: 10px;
            vertical-align: middle;
        }
        
        .form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }
        
        .form-title {
            color: #2c3e50;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-mode-indicator {
            background-color: #9b59b6;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .edit-mode {
            background-color: #ffc107;
            color: #333;
        }
        
        .auto-load-options {
            background-color: #e8f4fc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #3498db;
        }
        
        .auto-load-options h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .auto-load-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .auto-load-checkbox input[type="checkbox"] {
            width: auto;
        }
        
        .auto-load-checkbox label {
            margin-bottom: 0;
            font-weight: normal;
        }
        
        .load-first-btn {
            background-color: #3498db;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }
        
        .load-all-btn {
            background-color: #9b59b6;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
            margin-left: 10px;
        }
        
        .json-preview {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            border: 1px solid #ddd;
            font-family: monospace;
            font-size: 0.9rem;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
        
        .json-preview.show {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        /* Styles pour l'authentification */
        .auth-container {
            max-width: 400px;
            margin: 50px auto;
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .auth-header h2 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .auth-header p {
            color: #64748b;
        }
        
        .auth-form {
            margin-top: 20px;
        }
        
        .auth-form-group {
            margin-bottom: 20px;
        }
        
        .auth-form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .auth-form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }
        
        .auth-btn {
            width: 100%;
            padding: 14px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .auth-btn:hover {
            background-color: #2980b9;
        }
        
        .auth-error {
            color: #e74c3c;
            text-align: center;
            margin-top: 15px;
            font-size: 0.9rem;
            display: none;
        }
        
        .locked-tab {
            position: relative;
        }
        
        .locked-tab::after {
            content: "üîí";
            font-size: 0.8rem;
            margin-left: 5px;
        }
        
        .login-prompt {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
        }
        
        .login-prompt i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #cbd5e1;
        }
        
        .login-btn {
            background-color: #3498db;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-info {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: rgba(255, 255, 255, 0.1);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .logout-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 0.8rem;
            padding: 3px 8px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        
        .logout-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .access-denied {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            color: #856404;
        }
        
        .access-denied h4 {
            color: #856404;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Styles pour l'onglet CARTE */
        .carte-form {
            background-color: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            border: 1px solid #e2e8f0;
        }
        
        .carte-item {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #e74c3c;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .carte-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            align-items: flex-start;
        }
        
        .carte-name {
            font-weight: bold;
            color: #2c3e50;
            font-size: 1.2rem;
        }
        
        .carte-group {
            color: #64748b;
            font-size: 0.9rem;
            background-color: #e2e8f0;
            padding: 4px 10px;
            border-radius: 15px;
        }
        
        .carte-contact {
            color: #27ae60;
            margin: 8px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .carte-congregation {
            color: #3498db;
            margin: 8px 0;
            font-weight: 600;
        }
        
        .carte-address {
            color: #7f8c8d;
            margin: 8px 0;
            font-style: italic;
        }
        
        .carte-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .carte-actions button {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .map-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }
        
        .map-buttons button {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            min-width: 150px;
        }
        
        .whatsapp-contact {
            color: #25D366;
            font-weight: bold;
        }
        
        .phone-contact {
            color: #3498db;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- Interface d'authentification -->
    <div id="authContainer" class="auth-container" style="display: none;">
        <div class="auth-header">
            <div class="jw-logo" style="width: 60px; height: 60px; line-height: 60px; font-size: 2.5rem; margin-bottom: 15px;">
                <span>JW</span>
            </div>
            <h2>Acc√®s Prot√©g√©</h2>
            <p>Veuillez vous identifier pour acc√©der √† l'onglet RDV</p>
        </div>
        
        <form id="authForm">
            <div class="auth-form-group">
                <label for="username"><i class="fas fa-user"></i> Identifiant</label>
                <input type="text" id="username" name="username" placeholder="Entrez votre identifiant" required>
            </div>
            
            <div class="auth-form-group">
                <label for="password"><i class="fas fa-lock"></i> Mot de passe</label>
                <input type="password" id="password" name="password" placeholder="Entrez votre mot de passe" required>
            </div>
            
            <button type="submit" class="auth-btn">
                <i class="fas fa-sign-in-alt"></i> Se connecter
            </button>
            
            <div id="authError" class="auth-error">
                <i class="fas fa-exclamation-circle"></i> Identifiant ou mot de passe incorrect
            </div>
            
            <div style="margin-top: 20px; font-size: 0.9rem; color: #64748b; text-align: center;">
                <p><strong>Identifiant:</strong> KARA NORD</p>
                <p><strong>Mot de passe:</strong> KARA1@</p>
            </div>
        </form>
    </div>
    
    <!-- Interface principale (cach√©e par d√©faut) -->
    <div id="mainContainer" class="container" style="display: none;">
        <header>
            <div class="jw-decoration left">JW</div>
            <div class="jw-decoration right">JW</div>
            
            <div id="userInfo" class="user-info" style="display: none;">
                <i class="fas fa-user-circle"></i>
                <span id="currentUser"></span>
                <button type="button" id="logoutBtn" class="logout-btn" title="Se d√©connecter">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
            
            <div class="jw-logo">
                <span>JW</span>
            </div>
            <h1>Pr√™chons</h1>
            <p class="subtitle">Application de suivi des activit√©s de pr√©dication</p>
        </header>
        
        <div class="tabs-container">
            <div class="tab active" data-tab="rdv" id="rdvTab">
                <i class="fas fa-calendar-check"></i> RDV
            </div>
            <div class="tab" data-tab="cahier">
                <i class="fas fa-book"></i> Cahier d'activit√©
            </div>
            <div class="tab" data-tab="carte">
                <i class="fas fa-map"></i> CARTE
            </div>
            <div class="tab" data-tab="liste">
                <i class="fas fa-list"></i> Liste
            </div>
            <div class="tab" data-tab="statistiques">
                <i class="fas fa-chart-bar"></i> Statistiques
            </div>
        </div>
        
        <!-- Onglet RDV (prot√©g√©) -->
        <div id="rdv-tab" class="tab-content active">
            <!-- Message d'acc√®s refus√© (visible uniquement si non authentifi√©) -->
            <div id="accessDenied" class="access-denied" style="display: none;">
                <h4><i class="fas fa-lock"></i> Acc√®s Restreint</h4>
                <p>L'acc√®s √† l'onglet RDV est r√©serv√© aux membres autoris√©s du groupe KARA NORD.</p>
                <p>Veuillez vous connecter pour acc√©der √† cette fonctionnalit√©.</p>
                <button type="button" id="loginFromDeniedBtn" class="login-btn">
                    <i class="fas fa-sign-in-alt"></i> Se connecter
                </button>
            </div>
            
            <!-- Contenu RDV (visible uniquement si authentifi√©) -->
            <div id="rdvContent" style="display: none;">
                <div class="form-header">
                    <div class="form-title">
                        <i class="fas fa-calendar-check"></i>
                        <span id="formTitle">Nouvelle pr√©dication</span>
                    </div>
                    <div id="formMode" class="form-mode-indicator" style="display: none;">
                        Mode √©dition
                    </div>
                </div>
                
                <div class="auto-load-options" id="autoLoadOptions" style="display: none;">
                    <h4><i class="fas fa-file-import"></i> Fichier JSON import√©</h4>
                    <div class="auto-load-checkbox">
                        <input type="checkbox" id="autoLoadCheckbox" checked>
                        <label for="autoLoadCheckbox">Charger automatiquement le premier √©l√©ment dans le formulaire</label>
                    </div>
                    <div>
                        <button type="button" id="loadFirstBtn" class="load-first-btn">
                            <i class="fas fa-arrow-right"></i> Charger le premier √©l√©ment
                        </button>
                        <button type="button" id="loadAllBtn" class="load-all-btn">
                            <i class="fas fa-list"></i> Voir tous les √©l√©ments
                        </button>
                    </div>
                    <div class="json-preview" id="jsonPreview">
                        <!-- Aper√ßu JSON -->
                    </div>
                </div>
                
                <form id="preachingForm">
                    <input type="hidden" id="editingId" name="editingId" value="">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="date">
                                <i class="fas fa-calendar-alt"></i> Date de pr√©dication
                            </label>
                            <input type="date" id="date" name="date" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="location">
                                <i class="fas fa-map-marker-alt"></i> Lieu de pr√©dication
                            </label>
                            <input type="text" id="location" name="location" placeholder="Entrez le lieu de pr√©dication" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="group">
                                <i class="fas fa-users"></i> Groupe de pr√©dication
                            </label>
                            <select id="group" name="group" required>
                                <option value="">S√©lectionnez un groupe</option>
                                <option value="Groupe 1">Groupe 1</option>
                                <option value="Groupe 2">Groupe 2</option>
                                <option value="Groupe 3">Groupe 3</option>
                                <option value="Groupe 4">Groupe 4</option>
                                <option value="Groupe 5">Groupe 5</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="neighborhood">
                                <i class="fas fa-city"></i> Quartier
                            </label>
                            <input type="text" id="neighborhood" name="neighborhood" placeholder="Entrez le quartier" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="preaching">
                                <span class="jw-form-icon">JW</span> Pr√©dication / Notes
                            </label>
                            <textarea id="preaching" name="preaching" rows="5" placeholder="Notes de pr√©dication, sujets abord√©s, observations..."></textarea>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label><i class="fas fa-map-pin"></i> Coordonn√©es GPS (automatiques)</label>
                            <div class="gps-coordinates">
                                <div>
                                    <span id="latitude">Latitude: En attente de localisation...</span>
                                    <span id="longitude">Longitude: En attente de localisation...</span>
                                </div>
                                <div>
                                    <span id="gpsStatus" class="gps-status inactive">GPS non activ√©</span>
                                </div>
                            </div>
                            <button type="button" id="getLocationBtn" class="btn btn-primary" style="margin-top: 10px; padding: 10px 15px;">
                                <i class="fas fa-satellite"></i> Obtenir la localisation
                            </button>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button type="button" id="importBtn" class="btn btn-import">
                            <i class="fas fa-file-import"></i> Importer JSON
                        </button>
                        
                        <button type="button" id="exportBtn" class="btn btn-export">
                            <i class="fas fa-file-export"></i> Exporter JSON
                        </button>
                        
                        <button type="button" id="whatsappBtn" class="btn btn-whatsapp">
                            <i class="fab fa-whatsapp"></i> Envoyer via WhatsApp
                        </button>
                        
                        <button type="submit" id="saveBtn" class="btn btn-success">
                            <i class="fas fa-save"></i> Enregistrer
                        </button>
                        
                        <button type="button" id="cancelEditBtn" class="btn" style="background-color: #7f8c8d; color: white; display: none;">
                            <i class="fas fa-times"></i> Annuler l'√©dition
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Onglet Cahier d'activit√© -->
        <div id="cahier-tab" class="tab-content">
            <div class="form-header">
                <div class="form-title">
                    <i class="fas fa-book"></i>
                    <span id="activityFormTitle">Nouvelle entr√©e dans le cahier d'activit√©</span>
                </div>
                <div id="activityFormMode" class="form-mode-indicator" style="display: none;">
                    Mode √©dition
                </div>
            </div>
            
            <div class="auto-load-options" id="activityAutoLoadOptions" style="display: none;">
                <h4><i class="fas fa-file-import"></i> Fichier JSON import√© (Activit√©s)</h4>
                <div class="auto-load-checkbox">
                    <input type="checkbox" id="activityAutoLoadCheckbox" checked>
                    <label for="activityAutoLoadCheckbox">Charger automatiquement le premier √©l√©ment dans le formulaire</label>
                </div>
                <div>
                    <button type="button" id="activityLoadFirstBtn" class="load-first-btn">
                        <i class="fas fa-arrow-right"></i> Charger le premier √©l√©ment
                    </button>
                    <button type="button" id="activityLoadAllBtn" class="load-all-btn">
                        <i class="fas fa-list"></i> Voir tous les √©l√©ments
                    </button>
                </div>
                <div class="json-preview" id="activityJsonPreview">
                    <!-- Aper√ßu JSON -->
                </div>
            </div>
            
            <div class="activity-form">
                <form id="activityForm">
                    <input type="hidden" id="editingActivityId" name="editingActivityId" value="">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="personName"><i class="fas fa-user"></i> Nom de la prochaine √©tude</label>
                            <input type="text" id="personName" name="personName" placeholder="Nom de la personne ou famille" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="theme"><i class="fas fa-book-open"></i> Th√®me abord√©</label>
                            <input type="text" id="theme" name="theme" placeholder="Sujet principal abord√©" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="verse"><i class="fas fa-bible"></i> Verset ou publication pr√©sent√©</label>
                            <input type="text" id="verse" name="verse" placeholder="Ex: Jean 3:16 ou 'La Tour de Garde Janvier 2024'">
                        </div>
                        
                        <div class="form-group">
                            <label for="suspendedTheme"><i class="fas fa-pause-circle"></i> Th√®me en suspens</label>
                            <input type="text" id="suspendedTheme" name="suspendedTheme" placeholder="Sujet √† reprendre lors de la prochaine visite">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="nextVisitDate"><i class="fas fa-calendar-day"></i> Date de la prochaine visite</label>
                            <input type="date" id="nextVisitDate" name="nextVisitDate" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="nextVisitTime"><i class="fas fa-clock"></i> Heure de la visite</label>
                            <input type="time" id="nextVisitTime" name="nextVisitTime" required>
                        </div>
                    </div>
                    
                    <!-- Section GPS pour le cahier d'activit√© -->
                    <div class="gps-section">
                        <h4><i class="fas fa-map-marked-alt"></i> Localisation GPS de l'√©tude</h4>
                        <div class="gps-info" id="activityGpsInfo">
                            <p>Cliquez sur "Obtenir la localisation" pour capturer les coordonn√©es GPS actuelles.</p>
                        </div>
                        
                        <div class="gps-buttons">
                            <button type="button" id="getActivityLocationBtn" class="btn-gps">
                                <i class="fas fa-satellite"></i> Obtenir la localisation
                            </button>
                            <button type="button" id="insertGpsBtn" class="btn-primary">
                                <i class="fas fa-map-pin"></i> Ins√©rer dans les notes
                            </button>
                            <button type="button" id="getAddressBtn" class="btn-success">
                                <i class="fas fa-home"></i> Obtenir l'adresse
                            </button>
                        </div>
                        
                        <div class="address-info" id="addressInfo">
                            <h5><i class="fas fa-address-card"></i> Adresse d√©tect√©e :</h5>
                            <div id="addressDetails">
                                <!-- L'adresse sera affich√©e ici -->
                            </div>
                            <div class="coordinates-display">
                                <div class="coordinate-item">
                                    <strong>Latitude:</strong> <span id="activityLatitude">Non disponible</span>
                                </div>
                                <div class="coordinate-item">
                                    <strong>Longitude:</strong> <span id="activityLongitude">Non disponible</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Section de recherche intelligente -->
                    <div class="search-section">
                        <h4><i class="fas fa-search"></i> Recherche intelligente vers JW</h4>
                        <div class="search-input-group">
                            <input type="text" id="searchQuery" placeholder="Rechercher un verset, un th√®me ou une publication...">
                            <button type="button" id="searchBtn" class="btn btn-search">
                                <i class="fas fa-external-link-alt"></i> Rechercher
                            </button>
                        </div>
                        <div class="predefined-searches">
                            <button type="button" class="predefined-search" data-query="Jean 3:16">Jean 3:16</button>
                            <button type="button" class="predefined-search" data-query="Psaume 83:18">Psaume 83:18</button>
                            <button type="button" class="predefined-search" data-query="R√©surrection">R√©surrection</button>
                            <button type="button" class="predefined-search" data-query="Royaume de Dieu">Royaume de Dieu</button>
                            <button type="button" class="predefined-search" data-query="Amour de Dieu">Amour de Dieu</button>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label><i class="fas fa-sticky-note"></i> Notes suppl√©mentaires (√©diteur enrichi)</label>
                            <div class="rich-editor-container">
                                <div class="rich-editor-toolbar">
                                    <button type="button" data-command="bold" title="Gras">
                                        <i class="fas fa-bold"></i>
                                    </button>
                                    <button type="button" data-command="italic" title="Italique">
                                        <i class="fas fa-italic"></i>
                                    </button>
                                    <button type="button" data-command="underline" title="Soulign√©">
                                        <i class="fas fa-underline"></i>
                                    </button>
                                    <button type="button" data-command="insertUnorderedList" title="Liste √† puces">
                                        <i class="fas fa-list-ul"></i>
                                    </button>
                                    <button type="button" data-command="insertOrderedList" title="Liste num√©rot√©e">
                                        <i class="fas fa-list-ol"></i>
                                    </button>
                                    <button type="button" data-command="createLink" title="Lien">
                                        <i class="fas fa-link"></i>
                                    </button>
                                    <button type="button" data-command="formatBlock" data-value="h2" title="Titre">
                                        <i class="fas fa-heading"></i>
                                    </button>
                                    <button type="button" data-command="formatBlock" data-value="blockquote" title="Citation">
                                        <i class="fas fa-quote-right"></i>
                                    </button>
                                    <button type="button" id="clearFormatting" title="Effacer le formatage">
                                        <i class="fas fa-eraser"></i>
                                    </button>
                                </div>
                                <div class="rich-editor-content" id="richNotes" data-placeholder="Observations, points √† approfondir, questions pos√©es..." contenteditable="true"></div>
                            </div>
                            <input type="hidden" id="notes" name="notes">
                            <input type="hidden" id="activityLatitudeInput" name="activityLatitude">
                            <input type="hidden" id="activityLongitudeInput" name="activityLongitude">
                            <input type="hidden" id="activityAddress" name="activityAddress">
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button type="button" id="activityImportBtn" class="btn btn-import">
                            <i class="fas fa-file-import"></i> Importer JSON
                        </button>
                        
                        <button type="button" id="activityExportBtn" class="btn btn-export">
                            <i class="fas fa-file-export"></i> Exporter JSON
                        </button>
                        
                        <button type="submit" id="saveActivityBtn" class="btn btn-success">
                            <i class="fas fa-save"></i> Ajouter au cahier
                        </button>
                        
                        <button type="button" id="clearActivityForm" class="btn btn-primary">
                            <i class="fas fa-eraser"></i> Effacer le formulaire
                        </button>
                        
                        <button type="button" id="cancelActivityEditBtn" class="btn" style="background-color: #7f8c8d; color: white; display: none;">
                            <i class="fas fa-times"></i> Annuler l'√©dition
                        </button>
                    </div>
                </form>
            </div>
            
            <h3 style="margin-bottom: 20px; color: #2c3e50;">
                <i class="fas fa-book"></i> Entr√©es du cahier d'activit√©
            </h3>
            
            <div id="activityList">
                <!-- Les activit√©s seront ajout√©es ici dynamiquement -->
                <div class="empty-list">
                    <i class="fas fa-book-open"></i>
                    <h3>Cahier d'activit√© vide</h3>
                    <p>Ajoutez votre premi√®re entr√©e pour commencer √† suivre vos activit√©s</p>
                </div>
            </div>
        </div>
        
        <!-- NOUVEL ONGLET CARTE -->
        <div id="carte-tab" class="tab-content">
            <div class="form-header">
                <div class="form-title">
                    <i class="fas fa-map"></i>
                    <span id="carteFormTitle">Nouvelle fiche fr√®re/s≈ìur</span>
                </div>
                <div id="carteFormMode" class="form-mode-indicator" style="display: none;">
                    Mode √©dition
                </div>
            </div>
            
            <div class="auto-load-options" id="carteAutoLoadOptions" style="display: none;">
                <h4><i class="fas fa-file-import"></i> Fichier JSON import√© (Carte)</h4>
                <div class="auto-load-checkbox">
                    <input type="checkbox" id="carteAutoLoadCheckbox" checked>
                    <label for="carteAutoLoadCheckbox">Charger automatiquement le premier √©l√©ment dans le formulaire</label>
                </div>
                <div>
                    <button type="button" id="carteLoadFirstBtn" class="load-first-btn">
                        <i class="fas fa-arrow-right"></i> Charger le premier √©l√©ment
                    </button>
                    <button type="button" id="carteLoadAllBtn" class="load-all-btn">
                        <i class="fas fa-list"></i> Voir tous les √©l√©ments
                    </button>
                </div>
                <div class="json-preview" id="carteJsonPreview">
                    <!-- Aper√ßu JSON -->
                </div>
            </div>
            
            <div class="carte-form">
                <form id="carteForm">
                    <input type="hidden" id="editingCarteId" name="editingCarteId" value="">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="carteName"><i class="fas fa-user"></i> Nom et pr√©nom</label>
                            <input type="text" id="carteName" name="carteName" placeholder="Nom complet du fr√®re/soeur" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="carteType"><i class="fas fa-user-tag"></i> Statut</label>
                            <select id="carteType" name="carteType" required>
                                <option value="">S√©lectionnez le statut</option>
                                <option value="Fr√®re">Fr√®re</option>
                                <option value="S≈ìur">S≈ìur</option>
                                <option value="Famille">Famille</option>
                                <option value="Ancien">Ancien</option>
                                <option value="Servant Minist√©riel">Servant Minist√©riel</option>
                                <option value="Pr√©dicateur">Pr√©dicateur</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="carteGroup"><i class="fas fa-users"></i> Groupe</label>
                            <select id="carteGroup" name="carteGroup" required>
                                <option value="">S√©lectionnez un groupe</option>
                                <option value="Groupe 1">Groupe 1</option>
                                <option value="Groupe 2">Groupe 2</option>
                                <option value="Groupe 3">Groupe 3</option>
                                <option value="Groupe 4">Groupe 4</option>
                                <option value="Groupe 5">Groupe 5</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="carteCongregation"><i class="fas fa-church"></i> Congr√©gation</label>
                            <input type="text" id="carteCongregation" name="carteCongregation" placeholder="Nom de la congr√©gation" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="cartePhone"><i class="fas fa-phone"></i> T√©l√©phone</label>
                            <input type="tel" id="cartePhone" name="cartePhone" placeholder="Num√©ro de t√©l√©phone" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="carteWhatsApp"><i class="fab fa-whatsapp"></i> WhatsApp</label>
                            <input type="tel" id="carteWhatsApp" name="carteWhatsApp" placeholder="Num√©ro WhatsApp (optionnel)">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="carteAddress"><i class="fas fa-map-marker-alt"></i> Adresse</label>
                            <textarea id="carteAddress" name="carteAddress" rows="3" placeholder="Adresse compl√®te" required></textarea>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label><i class="fas fa-map-pin"></i> Coordonn√©es GPS</label>
                            <div class="gps-coordinates">
                                <div>
                                    <span id="carteLatitude">Latitude: En attente de localisation...</span>
                                    <span id="carteLongitude">Longitude: En attente de localisation...</span>
                                </div>
                                <div>
                                    <span id="carteGpsStatus" class="gps-status inactive">GPS non activ√©</span>
                                </div>
                            </div>
                            <button type="button" id="getCarteLocationBtn" class="btn btn-primary" style="margin-top: 10px; padding: 10px 15px;">
                                <i class="fas fa-satellite"></i> Obtenir la localisation
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="carteNotes"><i class="fas fa-sticky-note"></i> Notes suppl√©mentaires</label>
                            <textarea id="carteNotes" name="carteNotes" rows="4" placeholder="Informations compl√©mentaires, observations..."></textarea>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button type="button" id="carteImportBtn" class="btn btn-import">
                            <i class="fas fa-file-import"></i> Importer JSON
                        </button>
                        
                        <button type="button" id="carteExportBtn" class="btn btn-export">
                            <i class="fas fa-file-export"></i> Exporter JSON
                        </button>
                        
                        <button type="button" id="carteWhatsAppBtn" class="btn btn-whatsapp">
                            <i class="fab fa-whatsapp"></i> Envoyer via WhatsApp
                        </button>
                        
                        <button type="submit" id="saveCarteBtn" class="btn btn-success">
                            <i class="fas fa-save"></i> Enregistrer
                        </button>
                        
                        <button type="button" id="cancelCarteEditBtn" class="btn" style="background-color: #7f8c8d; color: white; display: none;">
                            <i class="fas fa-times"></i> Annuler l'√©dition
                        </button>
                    </div>
                </form>
                
                <!-- Boutons pour les cartes -->
                <div class="map-buttons">
                    <button type="button" id="generateMapBtn" class="btn btn-map">
                        <i class="fas fa-map-marked-alt"></i> G√©n√©rer une carte
                    </button>
                    <button type="button" id="gpxBtn" class="btn btn-gps" onclick="window.open('https://play.google.com/store/apps/details?id=com.vecturagames.android.app.gpxviewer&pcampaignid=web_share', '_blank')">
                        <i class="fas fa-map-signs"></i> GPX Viewer
                    </button>
                    <button type="button" id="positionBtn" class="btn btn-position" onclick="window.open('https://play.google.com/store/apps/details?id=com.location.test', '_blank')">
                        <i class="fas fa-location-arrow"></i> Ma position
                    </button>
                </div>
            </div>
            
            <h3 style="margin-bottom: 20px; color: #2c3e50;">
                <i class="fas fa-users"></i> Liste des fr√®res et s≈ìurs
            </h3>
            
            <div id="carteList">
                <!-- Les fiches seront ajout√©es ici dynamiquement -->
                <div class="empty-list">
                    <i class="fas fa-map"></i>
                    <h3>Aucune fiche enregistr√©e</h3>
                    <p>Ajoutez votre premi√®re fiche fr√®re/s≈ìur pour commencer</p>
                </div>
            </div>
        </div>
        
        <!-- Onglet Liste -->
        <div id="liste-tab" class="tab-content">
            <div class="list-content">
                <h2 style="margin-bottom: 20px; color: #2c3e50;">Liste des pr√©dications</h2>
                <div id="preachingList">
                    <!-- Les pr√©dications seront ajout√©es ici dynamiquement -->
                    <div class="empty-list">
                        <i class="fas fa-calendar-times"></i>
                        <h3>Aucune pr√©dication enregistr√©e</h3>
                        <p>Ajoutez votre premi√®re pr√©dication dans l'onglet "RDV"</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Onglet Statistiques -->
        <div id="statistiques-tab" class="tab-content">
            <div class="list-content">
                <h2 style="margin-bottom: 20px; color: #2c3e50;">Statistiques</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon" style="color: #d4a017;">
                            <div class="jw-stat-icon">
                                <span>JW</span>
                            </div>
                        </div>
                        <h3 style="color: #2c3e50;">Total des pr√©dications</h3>
                        <div id="totalPreachings" class="stat-value">0</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="color: #27ae60;">
                            <i class="fas fa-users"></i>
                        </div>
                        <h3 style="color: #2c3e50;">Groupes actifs</h3>
                        <div id="activeGroups" class="stat-value">0</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="color: #9b59b6;">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <h3 style="color: #2c3e50;">Lieux diff√©rents</h3>
                        <div id="differentLocations" class="stat-value">0</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="color: #e74c3c;">
                            <i class="fas fa-book"></i>
                        </div>
                        <h3 style="color: #2c3e50;">√âtudes suivies</h3>
                        <div id="totalActivities" class="stat-value">0</div>
                    </div>
                </div>
                
                <div style="margin-top: 40px;">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">R√©partition par groupe</h3>
                    <div id="groupDistribution" style="background-color: #f8f9fa; padding: 20px; border-radius: 8px;">
                        <p style="color: #64748b; text-align: center;">Aucune donn√©e disponible</p>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>Application "Pr√™chons" - Suivi des activit√©s de pr√©dication</p>
            <p>Num√©ro WhatsApp du groupe : <strong>+228 92871605</strong></p>
            <p>Recherche intelligente via : <strong>https://www.ia-elian.com/</strong></p>
        </footer>
    </div>
    
    <div id="notification" class="notification"></div>
    
    <!-- Input cach√© pour l'import de fichier (principal) -->
    <input type="file" id="fileInput" accept=".json" style="display: none;">
    
    <!-- Input cach√© pour l'import de fichier (activit√©s) -->
    <input type="file" id="activityFileInput" accept=".json" style="display: none;">
    
    <!-- Input cach√© pour l'import de fichier (carte) -->
    <input type="file" id="carteFileInput" accept=".json" style="display: none;">
    
    <!-- Modal pour les liens -->
    <div id="linkModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
        <div style="background-color: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 500px;">
            <h3 style="margin-bottom: 20px; color: #2c3e50;">
                <i class="fas fa-link"></i> Ins√©rer un lien
            </h3>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">URL du lien</label>
                <input type="text" id="linkUrl" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" placeholder="https://exemple.com">
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                <button id="cancelLink" style="padding: 10px 20px; background-color: #e2e8f0; border: none; border-radius: 4px; cursor: pointer;">
                    Annuler
                </button>
                <button id="insertLink" style="padding: 10px 20px; background-color: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Ins√©rer
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // √âl√©ments du DOM pour l'authentification
        const authContainer = document.getElementById('authContainer');
        const mainContainer = document.getElementById('mainContainer');
        const authForm = document.getElementById('authForm');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const authError = document.getElementById('authError');
        const currentUser = document.getElementById('currentUser');
        const userInfo = document.getElementById('userInfo');
        const logoutBtn = document.getElementById('logoutBtn');
        const accessDenied = document.getElementById('accessDenied');
        const rdvContent = document.getElementById('rdvContent');
        const rdvTab = document.getElementById('rdvTab');
        const loginFromDeniedBtn = document.getElementById('loginFromDeniedBtn');
        
        // √âl√©ments du DOM principaux
        const form = document.getElementById('preachingForm');
        const activityForm = document.getElementById('activityForm');
        const carteForm = document.getElementById('carteForm');
        const latitudeElement = document.getElementById('latitude');
        const longitudeElement = document.getElementById('longitude');
        const gpsStatusElement = document.getElementById('gpsStatus');
        const getLocationBtn = document.getElementById('getLocationBtn');
        const getActivityLocationBtn = document.getElementById('getActivityLocationBtn');
        const getCarteLocationBtn = document.getElementById('getCarteLocationBtn');
        const insertGpsBtn = document.getElementById('insertGpsBtn');
        const getAddressBtn = document.getElementById('getAddressBtn');
        const importBtn = document.getElementById('importBtn');
        const exportBtn = document.getElementById('exportBtn');
        const whatsappBtn = document.getElementById('whatsappBtn');
        const searchBtn = document.getElementById('searchBtn');
        const searchQuery = document.getElementById('searchQuery');
        const fileInput = document.getElementById('fileInput');
        const activityFileInput = document.getElementById('activityFileInput');
        const carteFileInput = document.getElementById('carteFileInput');
        const notification = document.getElementById('notification');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const preachingList = document.getElementById('preachingList');
        const activityList = document.getElementById('activityList');
        const carteList = document.getElementById('carteList');
        const clearActivityFormBtn = document.getElementById('clearActivityForm');
        const richNotes = document.getElementById('richNotes');
        const notesHiddenInput = document.getElementById('notes');
        const activityGpsInfo = document.getElementById('activityGpsInfo');
        const activityLatitudeElement = document.getElementById('activityLatitude');
        const activityLongitudeElement = document.getElementById('activityLongitude');
        const activityLatitudeInput = document.getElementById('activityLatitudeInput');
        const activityLongitudeInput = document.getElementById('activityLongitudeInput');
        const activityAddressInput = document.getElementById('activityAddress');
        const addressInfo = document.getElementById('addressInfo');
        const addressDetails = document.getElementById('addressDetails');
        const toolbarButtons = document.querySelectorAll('.rich-editor-toolbar button');
        const clearFormattingBtn = document.getElementById('clearFormatting');
        const linkModal = document.getElementById('linkModal');
        const linkUrl = document.getElementById('linkUrl');
        const cancelLink = document.getElementById('cancelLink');
        const insertLink = document.getElementById('insertLink');
        const predefinedSearchButtons = document.querySelectorAll('.predefined-search');
        const formTitle = document.getElementById('formTitle');
        const formMode = document.getElementById('formMode');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const editingIdInput = document.getElementById('editingId');
        const activityFormTitle = document.getElementById('activityFormTitle');
        const activityFormMode = document.getElementById('activityFormMode');
        const cancelActivityEditBtn = document.getElementById('cancelActivityEditBtn');
        const editingActivityIdInput = document.getElementById('editingActivityId');
        const autoLoadOptions = document.getElementById('autoLoadOptions');
        const autoLoadCheckbox = document.getElementById('autoLoadCheckbox');
        const loadFirstBtn = document.getElementById('loadFirstBtn');
        const loadAllBtn = document.getElementById('loadAllBtn');
        const jsonPreview = document.getElementById('jsonPreview');
        const activityAutoLoadOptions = document.getElementById('activityAutoLoadOptions');
        const activityAutoLoadCheckbox = document.getElementById('activityAutoLoadCheckbox');
        const activityLoadFirstBtn = document.getElementById('activityLoadFirstBtn');
        const activityLoadAllBtn = document.getElementById('activityLoadAllBtn');
        const activityJsonPreview = document.getElementById('activityJsonPreview');
        
        // √âl√©ments pour l'onglet CARTE
        const carteFormTitle = document.getElementById('carteFormTitle');
        const carteFormMode = document.getElementById('carteFormMode');
        const cancelCarteEditBtn = document.getElementById('cancelCarteEditBtn');
        const editingCarteIdInput = document.getElementById('editingCarteId');
        const carteAutoLoadOptions = document.getElementById('carteAutoLoadOptions');
        const carteAutoLoadCheckbox = document.getElementById('carteAutoLoadCheckbox');
        const carteLoadFirstBtn = document.getElementById('carteLoadFirstBtn');
        const carteLoadAllBtn = document.getElementById('carteLoadAllBtn');
        const carteJsonPreview = document.getElementById('carteJsonPreview');
        const carteImportBtn = document.getElementById('carteImportBtn');
        const carteExportBtn = document.getElementById('carteExportBtn');
        const carteWhatsAppBtn = document.getElementById('carteWhatsAppBtn');
        const saveCarteBtn = document.getElementById('saveCarteBtn');
        const generateMapBtn = document.getElementById('generateMapBtn');
        const carteLatitudeElement = document.getElementById('carteLatitude');
        const carteLongitudeElement = document.getElementById('carteLongitude');
        const carteGpsStatusElement = document.getElementById('carteGpsStatus');
        
        // Variables pour stocker les donn√©es
        let userLatitude = null;
        let userLongitude = null;
        let activityLatitude = null;
        let activityLongitude = null;
        let activityAddress = null;
        let carteLatitude = null;
        let carteLongitude = null;
        let preachings = JSON.parse(localStorage.getItem('preachings')) || [];
        let activities = JSON.parse(localStorage.getItem('activities')) || [];
        let cartes = JSON.parse(localStorage.getItem('cartes')) || [];
        let currentLinkCommand = null;
        let importedData = []; // Stocker les donn√©es import√©es
        let lastImportedData = null; // Derni√®res donn√©es import√©es
        let isActivityData = false; // Si les donn√©es import√©es sont pour les activit√©s
        let isCarteData = false; // Si les donn√©es import√©es sont pour les cartes
        
        // Variables d'authentification
        let isAuthenticated = false;
        let authenticatedUser = '';
        
        // Identifiants de connexion (KARA NORD)
        const VALID_USERNAME = "KARA NORD";
        const VALID_PASSWORD = "KARA1@";
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            // V√©rifier si l'utilisateur est d√©j√† authentifi√©
            checkAuthentication();
            
            // Initialiser les autres fonctionnalit√©s
            initApplication();
        });
        
        // V√©rifier l'authentification
        function checkAuthentication() {
            const savedAuth = localStorage.getItem('prechons_auth');
            if (savedAuth) {
                try {
                    const authData = JSON.parse(savedAuth);
                    if (authData.authenticated && authData.user === VALID_USERNAME) {
                        isAuthenticated = true;
                        authenticatedUser = authData.user;
                        showMainInterface();
                    } else {
                        showAuthInterface();
                    }
                } catch (e) {
                    showAuthInterface();
                }
            } else {
                showAuthInterface();
            }
        }
        
        // Afficher l'interface d'authentification
        function showAuthInterface() {
            authContainer.style.display = 'block';
            mainContainer.style.display = 'none';
            
            // R√©initialiser le formulaire
            authForm.reset();
            authError.style.display = 'none';
            
            // Focus sur le champ username
            setTimeout(() => {
                usernameInput.focus();
            }, 100);
        }
        
        // Afficher l'interface principale
        function showMainInterface() {
            authContainer.style.display = 'none';
            mainContainer.style.display = 'block';
            
            // Afficher les informations utilisateur
            currentUser.textContent = authenticatedUser;
            userInfo.style.display = 'flex';
            
            // Mettre √† jour l'affichage de l'onglet RDV
            updateRdvTabDisplay();
            
            // Initialiser l'application
            initApplicationFunctions();
        }
        
        // Mettre √† jour l'affichage de l'onglet RDV
        function updateRdvTabDisplay() {
            if (isAuthenticated) {
                // Afficher le contenu RDV
                accessDenied.style.display = 'none';
                rdvContent.style.display = 'block';
                
                // Retirer l'ic√¥ne de verrouillage
                rdvTab.classList.remove('locked-tab');
            } else {
                // Afficher le message d'acc√®s refus√©
                accessDenied.style.display = 'block';
                rdvContent.style.display = 'none';
                
                // Ajouter l'ic√¥ne de verrouillage
                rdvTab.classList.add('locked-tab');
            }
        }
        
        // Initialiser l'application
        function initApplication() {
            // Gestion du formulaire d'authentification
            authForm.addEventListener('submit', function(event) {
                event.preventDefault();
                
                const username = usernameInput.value.trim();
                const password = passwordInput.value;
                
                // V√©rifier les identifiants
                if (username === VALID_USERNAME && password === VALID_PASSWORD) {
                    // Authentification r√©ussie
                    isAuthenticated = true;
                    authenticatedUser = username;
                    
                    // Sauvegarder l'authentification
                    localStorage.setItem('prechons_auth', JSON.stringify({
                        authenticated: true,
                        user: username,
                        timestamp: new Date().toISOString()
                    }));
                    
                    // Afficher l'interface principale
                    showMainInterface();
                    
                    // Afficher une notification
                    showNotification(`Bienvenue ${authenticatedUser} !`, "success");
                } else {
                    // Authentification √©chou√©e
                    authError.style.display = 'block';
                    passwordInput.value = '';
                    passwordInput.focus();
                    
                    // Secouer le formulaire pour l'effet visuel
                    authContainer.style.animation = 'none';
                    setTimeout(() => {
                        authContainer.style.animation = 'shake 0.5s';
                    }, 10);
                }
            });
            
            // Gestion de la d√©connexion
            logoutBtn.addEventListener('click', function() {
                if (confirm("Voulez-vous vraiment vous d√©connecter ?")) {
                    // Supprimer l'authentification
                    localStorage.removeItem('prechons_auth');
                    
                    // R√©initialiser les variables
                    isAuthenticated = false;
                    authenticatedUser = '';
                    
                    // Afficher l'interface d'authentification
                    showAuthInterface();
                    
                    // Afficher une notification
                    showNotification("Vous avez √©t√© d√©connect√© avec succ√®s", "info");
                }
            });
            
            // Bouton de connexion depuis le message d'acc√®s refus√©
            loginFromDeniedBtn.addEventListener('click', function() {
                showAuthInterface();
            });
            
            // Initialiser les autres fonctionnalit√©s si authentifi√©
            if (isAuthenticated) {
                initApplicationFunctions();
            }
        }
        
        // Initialiser les fonctionnalit√©s de l'application
        function initApplicationFunctions() {
            updatePreachingList();
            updateActivityList();
            updateCarteList();
            updateStatistics();
            
            // D√©finir les dates par d√©faut
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
            document.getElementById('nextVisitDate').value = today;
            
            // D√©finir l'heure par d√©faut (dans 1 semaine √† 10h)
            const nextWeek = new Date();
            nextWeek.setDate(nextWeek.getDate() + 7);
            const nextWeekFormatted = nextWeek.toISOString().split('T')[0];
            document.getElementById('nextVisitDate').value = nextWeekFormatted;
            document.getElementById('nextVisitTime').value = '10:00';
            
            // Initialiser l'√©diteur enrichi
            initRichEditor();
            
            // Focus sur la recherche quand on ouvre l'onglet cahier
            const cahierTab = document.querySelector('.tab[data-tab="cahier"]');
            cahierTab.addEventListener('click', function() {
                setTimeout(() => {
                    searchQuery.focus();
                }, 300);
            });
            
            // Initialiser les boutons d'import/export pour l'onglet cahier
            initActivityImportExport();
            
            // Initialiser les fonctionnalit√©s de l'onglet CARTE
            initCarteFunctions();
        }
        
        // Initialiser les boutons d'import/export pour l'onglet cahier
        function initActivityImportExport() {
            // Bouton pour importer JSON pour les activit√©s
            activityImportBtn.addEventListener('click', function() {
                activityFileInput.click();
            });
            
            // Bouton pour exporter JSON des activit√©s
            activityExportBtn.addEventListener('click', exportActivityData);
            
            // G√©rer l'import de fichier pour les activit√©s
            activityFileInput.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        importedData = JSON.parse(e.target.result);
                        lastImportedData = importedData; // Sauvegarder pour r√©f√©rence future
                        
                        // V√©rifier si c'est un tableau
                        if (!Array.isArray(importedData)) {
                            // Si c'est un objet unique, le convertir en tableau
                            importedData = [importedData];
                            lastImportedData = importedData;
                        }
                        
                        // Marquer ces donn√©es comme √©tant pour les activit√©s
                        isActivityData = true;
                        isCarteData = false;
                        
                        // Ajouter un flag pour identifier les donn√©es import√©es
                        importedData.forEach((item, index) => {
                            item.imported = true;
                            item.id = Date.now() + Math.random() + index; // ID unique
                        });
                        
                        // Ajouter aux activit√©s existantes
                        activities = [...activities, ...importedData];
                        
                        // Sauvegarder dans le localStorage
                        localStorage.setItem('activities', JSON.stringify(activities));
                        
                        // Mettre √† jour l'affichage
                        updateActivityList();
                        
                        // Afficher les options de chargement automatique
                        activityAutoLoadOptions.style.display = 'block';
                        updateJsonPreview(importedData, activityJsonPreview);
                        
                        // Basculer vers l'onglet cahier si la case est coch√©e
                        if (activityAutoLoadCheckbox.checked && importedData.length > 0) {
                            // Charger le premier √©l√©ment dans le formulaire
                            loadActivityFromImportedData(importedData[0]);
                        }
                        
                        updateStatistics();
                        
                        showNotification(`Fichier JSON d'activit√©s import√© avec succ√®s! ${importedData.length} entr√©es ajout√©es.`, "success");
                        
                    } catch (error) {
                        console.error("Erreur lors de l'import du JSON:", error);
                        showNotification("Erreur: le fichier JSON est invalide.", "error");
                    }
                };
                
                reader.readAsText(file);
                
                // R√©initialiser l'input file
                event.target.value = '';
            });
        }
        
        // Initialiser les fonctionnalit√©s de l'onglet CARTE
        function initCarteFunctions() {
            // Bouton pour obtenir la localisation GPS pour la carte
            getCarteLocationBtn.addEventListener('click', getCarteLocation);
            
            // Bouton pour importer JSON pour les cartes
            carteImportBtn.addEventListener('click', function() {
                carteFileInput.click();
            });
            
            // Bouton pour exporter JSON des cartes
            carteExportBtn.addEventListener('click', exportCarteData);
            
            // Bouton pour envoyer via WhatsApp
            carteWhatsAppBtn.addEventListener('click', sendCarteViaWhatsApp);
            
            // Bouton pour g√©n√©rer une carte
            generateMapBtn.addEventListener('click', generateMap);
            
            // G√©rer l'import de fichier pour les cartes
            carteFileInput.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        importedData = JSON.parse(e.target.result);
                        lastImportedData = importedData; // Sauvegarder pour r√©f√©rence future
                        
                        // V√©rifier si c'est un tableau
                        if (!Array.isArray(importedData)) {
                            // Si c'est un objet unique, le convertir en tableau
                            importedData = [importedData];
                            lastImportedData = importedData;
                        }
                        
                        // Marquer ces donn√©es comme √©tant pour les cartes
                        isCarteData = true;
                        isActivityData = false;
                        
                        // CORRECTION : D√©tection am√©lior√©e des champs pour √©viter les erreurs
                        // Ajouter un flag pour identifier les donn√©es import√©es
                        importedData.forEach((item, index) => {
                            item.imported = true;
                            item.id = Date.now() + Math.random() + index; // ID unique
                            
                            // Assurer que tous les champs n√©cessaires existent
                            if (!item.carteName) item.carteName = "Nom inconnu";
                            if (!item.carteType) item.carteType = "Non sp√©cifi√©";
                            if (!item.carteGroup) item.carteGroup = "Non sp√©cifi√©";
                            if (!item.carteCongregation) item.carteCongregation = "Non sp√©cifi√©e";
                            if (!item.cartePhone) item.cartePhone = "Non sp√©cifi√©";
                        });
                        
                        // Ajouter aux cartes existantes
                        cartes = [...cartes, ...importedData];
                        
                        // Sauvegarder dans le localStorage
                        localStorage.setItem('cartes', JSON.stringify(cartes));
                        
                        // Mettre √† jour l'affichage
                        updateCarteList();
                        
                        // Afficher les options de chargement automatique
                        carteAutoLoadOptions.style.display = 'block';
                        updateCarteJsonPreview(importedData, carteJsonPreview);
                        
                        // Basculer vers l'onglet carte si la case est coch√©e
                        if (carteAutoLoadCheckbox.checked && importedData.length > 0) {
                            // Charger le premier √©l√©ment dans le formulaire
                            loadCarteFromImportedData(importedData[0]);
                        }
                        
                        showNotification(`Fichier JSON de cartes import√© avec succ√®s! ${importedData.length} entr√©es ajout√©es.`, "success");
                        
                    } catch (error) {
                        console.error("Erreur lors de l'import du JSON:", error);
                        showNotification("Erreur: le fichier JSON est invalide.", "error");
                    }
                };
                
                reader.readAsText(file);
                
                // R√©initialiser l'input file
                event.target.value = '';
            });
            
            // Gestion de la soumission du formulaire de carte
            carteForm.addEventListener('submit', function(event) {
                event.preventDefault();
                
                // R√©cup√©rer les donn√©es du formulaire
                const formData = new FormData(carteForm);
                const data = {};
                
                // Convertir FormData en objet
                formData.forEach((value, key) => {
                    data[key] = value;
                });
                
                // Ajouter les coordonn√©es GPS
                data.latitude = carteLatitude;
                data.longitude = carteLongitude;
                data.timestamp = new Date().toISOString();
                
                // V√©rifier si on est en mode √©dition
                const editingCarteId = editingCarteIdInput.value;
                if (editingCarteId) {
                    // Mode √©dition: mettre √† jour l'existant
                    data.id = editingCarteId;
                    
                    // Trouver l'index de la carte
                    const index = cartes.findIndex(c => c.id == editingCarteId);
                    
                    if (index !== -1) {
                        // Conserver les donn√©es existantes si non modifi√©es
                        cartes[index] = {...cartes[index], ...data};
                        showNotification("Fiche modifi√©e avec succ√®s!", "success");
                    }
                    
                    // Quitter le mode √©dition
                    cancelCarteEdit();
                } else {
                    // Mode cr√©ation: ajouter une nouvelle carte
                    data.id = Date.now(); // ID unique
                    
                    // Ajouter √† la liste des cartes
                    cartes.push(data);
                    showNotification("Fiche enregistr√©e avec succ√®s!", "success");
                }
                
                // Sauvegarder dans le localStorage
                localStorage.setItem('cartes', JSON.stringify(cartes));
                
                // Mettre √† jour l'affichage
                updateCarteList();
                
                // R√©initialiser le formulaire si pas en mode √©dition
                if (!editingCarteId) {
                    carteForm.reset();
                }
            });
            
            // Bouton pour charger le premier √©l√©ment import√© (cartes)
            carteLoadFirstBtn.addEventListener('click', function() {
                if (lastImportedData && lastImportedData.length > 0 && isCarteData) {
                    loadCarteFromImportedData(lastImportedData[0]);
                } else {
                    showNotification("Aucune donn√©e de carte import√©e √† charger", "warning");
                }
            });
            
            // Bouton pour voir tous les √©l√©ments import√©s (cartes)
            carteLoadAllBtn.addEventListener('click', function() {
                if (lastImportedData && lastImportedData.length > 0 && isCarteData) {
                    showNotification(`${lastImportedData.length} fiches import√©es ajout√©es √† la liste`, "info");
                } else {
                    showNotification("Aucune donn√©e de carte import√©e √† afficher", "warning");
                }
            });
        }
        
        // Fonction pour obtenir la localisation GPS pour la carte
        function getCarteLocation() {
            if (navigator.geolocation) {
                carteGpsStatusElement.textContent = "Localisation en cours...";
                carteGpsStatusElement.className = "gps-status inactive";
                
                navigator.geolocation.getCurrentPosition(
                    // Succ√®s
                    function(position) {
                        carteLatitude = position.coords.latitude;
                        carteLongitude = position.coords.longitude;
                        
                        carteLatitudeElement.textContent = `Latitude: ${carteLatitude.toFixed(6)}`;
                        carteLongitudeElement.textContent = `Longitude: ${carteLongitude.toFixed(6)}`;
                        
                        carteGpsStatusElement.textContent = "Localisation active";
                        carteGpsStatusElement.className = "gps-status active";
                        
                        showNotification("Localisation obtenue avec succ√®s pour la fiche!", "success");
                    },
                    // Erreur
                    function(error) {
                        console.error("Erreur de g√©olocalisation:", error);
                        carteGpsStatusElement.textContent = "Erreur de localisation";
                        carteGpsStatusElement.className = "gps-status inactive";
                        
                        // Coordonn√©es par d√©faut
                        carteLatitude = 6.1319;
                        carteLongitude = 1.2228;
                        carteLatitudeElement.textContent = `Latitude: ${carteLatitude.toFixed(6)} (d√©faut)`;
                        carteLongitudeElement.textContent = `Longitude: ${carteLongitude.toFixed(6)} (d√©faut)`;
                        
                        showNotification("Localisation par d√©faut utilis√©e. Activez le GPS pour une pr√©cision optimale.", "warning");
                    },
                    // Options
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                showNotification("La g√©olocalisation n'est pas support√©e par votre navigateur.", "error");
            }
        }
        
        // Fonction pour exporter les donn√©es d'activit√©
        function exportActivityData() {
            // R√©cup√©rer les donn√©es du formulaire d'activit√©
            const formData = new FormData(activityForm);
            const data = {};
            
            // Convertir FormData en objet
            formData.forEach((value, key) => {
                data[key] = value;
            });
            
            // Ajouter les notes enrichies
            data.notes = notesHiddenInput.value;
            
            // Ajouter les coordonn√©es GPS si disponibles
            if (activityLatitude && activityLongitude) {
                data.latitude = activityLatitude;
                data.longitude = activityLongitude;
                data.address = activityAddressInput.value;
            }
            
            // Ajouter un timestamp
            data.timestamp = new Date().toISOString();
            
            // Cr√©er un tableau avec les donn√©es (pour √™tre coh√©rent avec l'import)
            const exportData = [data];
            
            // Convertir en JSON
            const jsonData = JSON.stringify(exportData, null, 2);
            
            // Cr√©er un blob et un lien de t√©l√©chargement
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            // G√©n√©rer un nom de fichier avec la date
            const dateStr = new Date().toISOString().split('T')[0];
            a.download = `prechons_activites_${dateStr}.json`;
            
            // D√©clencher le t√©l√©chargement
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification("Donn√©es d'activit√© export√©es en JSON avec succ√®s!", "success");
        }
        
        // Fonction pour exporter les donn√©es de carte
        function exportCarteData() {
            // R√©cup√©rer les donn√©es du formulaire de carte
            const formData = new FormData(carteForm);
            const data = {};
            
            // Convertir FormData en objet
            formData.forEach((value, key) => {
                data[key] = value;
            });
            
            // Ajouter les coordonn√©es GPS si disponibles
            if (carteLatitude && carteLongitude) {
                data.latitude = carteLatitude;
                data.longitude = carteLongitude;
            }
            
            // Ajouter un timestamp
            data.timestamp = new Date().toISOString();
            
            // Cr√©er un tableau avec les donn√©es (pour √™tre coh√©rent avec l'import)
            const exportData = [data];
            
            // Convertir en JSON
            const jsonData = JSON.stringify(exportData, null, 2);
            
            // Cr√©er un blob et un lien de t√©l√©chargement
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            // G√©n√©rer un nom de fichier avec la date
            const dateStr = new Date().toISOString().split('T')[0];
            a.download = `prechons_cartes_${dateStr}.json`;
            
            // D√©clencher le t√©l√©chargement
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification("Donn√©es de carte export√©es en JSON avec succ√®s!", "success");
        }
        
        // Fonction pour envoyer la fiche via WhatsApp
        function sendCarteViaWhatsApp() {
            // R√©cup√©rer les donn√©es du formulaire
            const formData = new FormData(carteForm);
            const data = {};
            
            // Convertir FormData en objet
            formData.forEach((value, key) => {
                data[key] = value;
            });
            
            // V√©rifier que les champs obligatoires sont remplis
            if (!data.carteName || !data.carteType || !data.carteGroup || !data.carteCongregation || !data.cartePhone) {
                showNotification("Veuillez remplir tous les champs obligatoires avant d'envoyer.", "warning");
                return;
            }
            
            // Cr√©er le message WhatsApp
            let message = `*NOUVELLE FICHE FR√àRE/S≈íUR*\n\n`;
            message += `üë§ *Nom:* ${data.carteName}\n`;
            message += `üè∑Ô∏è *Statut:* ${data.carteType}\n`;
            message += `üë• *Groupe:* ${data.carteGroup}\n`;
            message += `‚õ™ *Congr√©gation:* ${data.carteCongregation}\n`;
            message += `üìû *T√©l√©phone:* ${data.cartePhone}\n`;
            
            if (data.carteWhatsApp) {
                message += `üí¨ *WhatsApp:* ${data.carteWhatsApp}\n`;
            }
            
            if (data.carteAddress) {
                message += `üìç *Adresse:* ${data.carteAddress}\n`;
            }
            
            if (carteLatitude && carteLongitude) {
                message += `üó∫Ô∏è *Coordonn√©es GPS:* ${carteLatitude.toFixed(6)}, ${carteLongitude.toFixed(6)}\n`;
                message += `https://maps.google.com/?q=${carteLatitude},${carteLongitude}\n`;
            }
            
            if (data.carteNotes) {
                message += `üìù *Notes:* ${data.carteNotes}\n`;
            }
            
            message += `\n_Enregistr√© via l'application Pr√™chons_`;
            
            // Encoder le message pour l'URL
            const encodedMessage = encodeURIComponent(message);
            
            // Num√©ro WhatsApp (+228 92871605)
            const phoneNumber = "+22892871605";
            
            // Cr√©er l'URL WhatsApp
            const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
            
            // Ouvrir WhatsApp dans une nouvelle fen√™tre
            window.open(whatsappUrl, '_blank');
            
            showNotification("Pr√©paration du message WhatsApp...", "success");
        }
        
        // Fonction pour g√©n√©rer une carte
        function generateMap() {
            if (cartes.length === 0) {
                showNotification("Aucune fiche enregistr√©e pour g√©n√©rer une carte", "warning");
                return;
            }
            
            // Cr√©er un contenu KML simple
            let kmlContent = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
<Document>
<name>Fr√®res et S≈ìurs - Congr√©gation</name>
<description>Cartographie des fr√®res et s≈ìurs</description>`;
            
            // Ajouter un marqueur pour chaque fiche avec coordonn√©es
            cartes.forEach((carte, index) => {
                if (carte.latitude && carte.longitude) {
                    kmlContent += `
<Placemark>
<name>${carte.carteName || 'Sans nom'}</name>
<description>
<![CDATA[
<b>${carte.carteName || 'Sans nom'}</b><br/>
Statut: ${carte.carteType || 'Non sp√©cifi√©'}<br/>
Groupe: ${carte.carteGroup || 'Non sp√©cifi√©'}<br/>
Congr√©gation: ${carte.carteCongregation || 'Non sp√©cifi√©e'}<br/>
T√©l√©phone: ${carte.cartePhone || 'Non sp√©cifi√©'}<br/>
${carte.carteWhatsApp ? `WhatsApp: ${carte.carteWhatsApp}<br/>` : ''}
Adresse: ${carte.carteAddress || 'Non sp√©cifi√©e'}<br/>
${carte.carteNotes ? `Notes: ${carte.carteNotes}<br/>` : ''}
]]>
</description>
<Point>
<coordinates>${carte.longitude},${carte.latitude},0</coordinates>
</Point>
</Placemark>`;
                }
            });
            
            kmlContent += `
</Document>
</kml>`;
            
            // Cr√©er un blob et un lien de t√©l√©chargement
            const blob = new Blob([kmlContent], { type: 'application/vnd.google-earth.kml+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'cartes_freres_soeurs.kml';
            
            // D√©clencher le t√©l√©chargement
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification("Carte KML g√©n√©r√©e avec succ√®s! Ouvrez-la avec Google Earth ou une application compatible.", "success");
        }
        
        // Gestion des onglets
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.getAttribute('data-tab');
                
                // V√©rifier l'acc√®s √† l'onglet RDV
                if (tabId === 'rdv' && !isAuthenticated) {
                    // Afficher le message d'acc√®s refus√©
                    updateRdvTabDisplay();
                    return;
                }
                
                // D√©sactiver tous les onglets
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));
                
                // Activer l'onglet s√©lectionn√©
                tab.classList.add('active');
                document.getElementById(`${tabId}-tab`).classList.add('active');
                
                // Si on passe √† l'onglet RDV, v√©rifier si on est en mode √©dition
                if (tabId === 'rdv' && editingIdInput.value) {
                    formMode.style.display = 'block';
                    formMode.classList.add('edit-mode');
                    formTitle.textContent = 'Modifier une pr√©dication';
                    cancelEditBtn.style.display = 'flex';
                }
                
                // Si on passe √† l'onglet cahier, v√©rifier si on est en mode √©dition
                if (tabId === 'cahier' && editingActivityIdInput.value) {
                    activityFormMode.style.display = 'block';
                    activityFormMode.classList.add('edit-mode');
                    activityFormTitle.textContent = 'Modifier une activit√©';
                    cancelActivityEditBtn.style.display = 'flex';
                }
                
                // Si on passe √† l'onglet carte, v√©rifier si on est en mode √©dition
                if (tabId === 'carte' && editingCarteIdInput.value) {
                    carteFormMode.style.display = 'block';
                    carteFormMode.classList.add('edit-mode');
                    carteFormTitle.textContent = 'Modifier une fiche';
                    cancelCarteEditBtn.style.display = 'flex';
                }
                
                // Afficher les options de chargement automatique si des donn√©es ont √©t√© import√©es
                if (tabId === 'rdv' && lastImportedData && !isActivityData && !isCarteData) {
                    autoLoadOptions.style.display = 'block';
                    updateJsonPreview(lastImportedData, jsonPreview);
                } else if (tabId === 'rdv') {
                    autoLoadOptions.style.display = 'none';
                }
                
                if (tabId === 'cahier' && lastImportedData && isActivityData) {
                    activityAutoLoadOptions.style.display = 'block';
                    updateJsonPreview(lastImportedData, activityJsonPreview);
                } else if (tabId === 'cahier') {
                    activityAutoLoadOptions.style.display = 'none';
                }
                
                if (tabId === 'carte' && lastImportedData && isCarteData) {
                    carteAutoLoadOptions.style.display = 'block';
                    updateCarteJsonPreview(lastImportedData, carteJsonPreview);
                } else if (tabId === 'carte') {
                    carteAutoLoadOptions.style.display = 'none';
                }
            });
        });
        
        // Fonction pour initialiser l'√©diteur enrichi
        function initRichEditor() {
            // G√©rer les boutons de la toolbar
            toolbarButtons.forEach(button => {
                if (button.dataset.command !== 'createLink') {
                    button.addEventListener('click', function(e) {
                        e.preventDefault();
                        const command = this.dataset.command;
                        const value = this.dataset.value;
                        
                        if (command === 'formatBlock') {
                            document.execCommand(command, false, value);
                        } else {
                            document.execCommand(command, false, null);
                        }
                        
                        // Mettre √† jour l'√©tat des boutons
                        updateToolbarButtons();
                    });
                }
            });
            
            // Bouton pour effacer le formatage
            clearFormattingBtn.addEventListener('click', function() {
                document.execCommand('removeFormat', false, null);
                document.execCommand('unlink', false, null);
                updateToolbarButtons();
            });
            
            // G√©rer le bouton de lien
            document.querySelector('[data-command="createLink"]').addEventListener('click', function(e) {
                e.preventDefault();
                currentLinkCommand = 'createLink';
                linkModal.style.display = 'flex';
                linkUrl.value = '';
                linkUrl.focus();
            });
            
            // G√©rer la modal de lien
            cancelLink.addEventListener('click', function() {
                linkModal.style.display = 'none';
                currentLinkCommand = null;
            });
            
            insertLink.addEventListener('click', function() {
                if (linkUrl.value.trim()) {
                    if (currentLinkCommand === 'createLink') {
                        document.execCommand('createLink', false, linkUrl.value);
                    }
                    linkModal.style.display = 'none';
                    currentLinkCommand = null;
                    updateToolbarButtons();
                }
            });
            
            // Fermer la modal en cliquant √† l'ext√©rieur
            linkModal.addEventListener('click', function(e) {
                if (e.target === linkModal) {
                    linkModal.style.display = 'none';
                    currentLinkCommand = null;
                }
            });
            
            // Mettre √† jour le champ cach√© lorsque le contenu change
            richNotes.addEventListener('input', function() {
                notesHiddenInput.value = this.innerHTML;
            });
            
            // Mettre √† jour l'√©tat des boutons de la toolbar
            richNotes.addEventListener('mouseup', updateToolbarButtons);
            richNotes.addEventListener('keyup', updateToolbarButtons);
        }
        
        // Fonction pour mettre √† jour l'√©tat des boutons de la toolbar
        function updateToolbarButtons() {
            toolbarButtons.forEach(button => {
                const command = button.dataset.command;
                const value = button.dataset.value;
                
                if (command === 'formatBlock') {
                    // V√©rifier si le format est appliqu√©
                    const isActive = document.queryCommandValue('formatBlock') === value;
                    button.classList.toggle('active', isActive);
                } else if (command) {
                    // V√©rifier si la commande est active
                    const isActive = document.queryCommandState(command);
                    button.classList.toggle('active', isActive);
                }
            });
        }
        
        // Recherche intelligente vers JW
        searchBtn.addEventListener('click', function() {
            performSearch();
        });
        
        // Recherche avec la touche Entr√©e
        searchQuery.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                performSearch();
            }
        });
        
        // Recherches pr√©d√©finies
        predefinedSearchButtons.forEach(button => {
            button.addEventListener('click', function() {
                searchQuery.value = this.dataset.query;
                performSearch();
            });
        });
        
        function performSearch() {
            const query = searchQuery.value.trim();
            if (!query) {
                showNotification("Veuillez entrer un terme de recherche", "warning");
                return;
            }
            
            // Construire l'URL de recherche
            const searchUrl = `https://www.ia-elian.com/?q=${encodeURIComponent(query)}`;
            
            // Ouvrir dans un nouvel onglet
            window.open(searchUrl, '_blank');
            
            // Ajouter le lien dans les notes
            const timestamp = new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            const searchNote = `<p><strong>Recherche effectu√©e √† ${timestamp}:</strong> <a href="${searchUrl}" target="_blank">${query}</a></p>`;
            
            // Ajouter aux notes existantes
            const currentContent = richNotes.innerHTML;
            richNotes.innerHTML = currentContent + (currentContent ? '<br>' : '') + searchNote;
            notesHiddenInput.value = richNotes.innerHTML;
            
            showNotification(`Recherche lanc√©e: "${query}"`, "success");
        }
        
        // Fonction pour obtenir la localisation GPS pour le formulaire principal
        function getLocation() {
            if (navigator.geolocation) {
                gpsStatusElement.textContent = "Localisation en cours...";
                gpsStatusElement.className = "gps-status inactive";
                
                navigator.geolocation.getCurrentPosition(
                    // Succ√®s
                    function(position) {
                        userLatitude = position.coords.latitude;
                        userLongitude = position.coords.longitude;
                        
                        latitudeElement.textContent = `Latitude: ${userLatitude.toFixed(6)}`;
                        longitudeElement.textContent = `Longitude: ${userLongitude.toFixed(6)}`;
                        
                        gpsStatusElement.textContent = "Localisation active";
                        gpsStatusElement.className = "gps-status active";
                        
                        showNotification("Localisation obtenue avec succ√®s!", "success");
                    },
                    // Erreur
                    function(error) {
                        console.error("Erreur de g√©olocalisation:", error);
                        gpsStatusElement.textContent = "Erreur de localisation";
                        gpsStatusElement.className = "gps-status inactive";
                        
                        // Coordonn√©es par d√©faut (exemple)
                        userLatitude = 6.1319;
                        userLongitude = 1.2228;
                        latitudeElement.textContent = `Latitude: ${userLatitude.toFixed(6)} (d√©faut)`;
                        longitudeElement.textContent = `Longitude: ${userLongitude.toFixed(6)} (d√©faut)`;
                        
                        showNotification("Localisation par d√©faut utilis√©e. Activez le GPS pour une pr√©cision optimale.", "warning");
                    },
                    // Options
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                showNotification("La g√©olocalisation n'est pas support√©e par votre navigateur.", "error");
            }
        }
        
        // Fonction pour obtenir la localisation GPS pour le cahier d'activit√©
        function getActivityLocation() {
            if (navigator.geolocation) {
                activityGpsInfo.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> Acquisition de la localisation en cours...</p>';
                
                navigator.geolocation.getCurrentPosition(
                    // Succ√®s
                    function(position) {
                        activityLatitude = position.coords.latitude;
                        activityLongitude = position.coords.longitude;
                        
                        // Mettre √† jour l'affichage
                        activityLatitudeElement.textContent = activityLatitude.toFixed(6);
                        activityLongitudeElement.textContent = activityLongitude.toFixed(6);
                        
                        // Mettre √† jour les champs cach√©s
                        activityLatitudeInput.value = activityLatitude;
                        activityLongitudeInput.value = activityLongitude;
                        
                        // Mettre √† jour l'affichage
                        activityGpsInfo.innerHTML = `
                            <p><i class="fas fa-check-circle" style="color: #27ae60;"></i> Localisation obtenue avec succ√®s !</p>
                            <div class="coordinates-display">
                                <div class="coordinate-item">
                                    <strong>Latitude:</strong> ${activityLatitude.toFixed(6)}
                                </div>
                                <div class="coordinate-item">
                                    <strong>Longitude:</strong> ${activityLongitude.toFixed(6)}
                                </div>
                            </div>
                            <p style="margin-top: 10px; font-size: 0.9em; color: #64748b;">
                                <i class="fas fa-info-circle"></i> Cliquez sur "Ins√©rer dans les notes" pour ajouter ces coordonn√©es √† vos notes.
                            </p>
                        `;
                        
                        showNotification("Localisation pour l'√©tude obtenue avec succ√®s!", "success");
                    },
                    // Erreur
                    function(error) {
                        console.error("Erreur de g√©olocalisation:", error);
                        activityGpsInfo.innerHTML = `
                            <p><i class="fas fa-exclamation-circle" style="color: #e74c3c;"></i> Erreur lors de l'acquisition de la localisation</p>
                            <p style="font-size: 0.9em; color: #64748b;">
                                V√©rifiez que les services de localisation sont activ√©s sur votre appareil.
                            </p>
                        `;
                        
                        // Coordonn√©es par d√©faut
                        activityLatitude = 6.1319;
                        activityLongitude = 1.2228;
                        activityLatitudeElement.textContent = activityLatitude.toFixed(6) + " (d√©faut)";
                        activityLongitudeElement.textContent = activityLongitude.toFixed(6) + " (d√©faut)";
                        activityLatitudeInput.value = activityLatitude;
                        activityLongitudeInput.value = activityLongitude;
                        
                        showNotification("Localisation par d√©faut utilis√©e pour l'√©tude.", "warning");
                    },
                    // Options
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                activityGpsInfo.innerHTML = '<p><i class="fas fa-exclamation-triangle" style="color: #f39c12;"></i> La g√©olocalisation n\'est pas support√©e par votre navigateur.</p>';
                showNotification("La g√©olocalisation n'est pas support√©e par votre navigateur.", "error");
            }
        }
        
        // Fonction pour obtenir l'adresse √† partir des coordonn√©es GPS
        function getAddressFromCoordinates(lat, lng) {
            if (!lat || !lng) {
                showNotification("Veuillez d'abord obtenir la localisation GPS", "warning");
                return;
            }
            
            // Utiliser l'API de g√©ocodage de Nominatim (OpenStreetMap)
            const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`;
            
            addressInfo.classList.remove('show');
            addressDetails.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> Recherche de l\'adresse en cours...</p>';
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data && data.address) {
                        const address = data.address;
                        let addressHtml = '';
                        
                        // Construire l'adresse de mani√®re lisible
                        if (address.road) addressHtml += `<div class="address-line"><i class="fas fa-road"></i> ${address.road}</div>`;
                        if (address.house_number) addressHtml += `<div class="address-line"><i class="fas fa-home"></i> ${address.house_number}</div>`;
                        if (address.suburb) addressHtml += `<div class="address-line"><i class="fas fa-map-marker"></i> ${address.suburb}</div>`;
                        if (address.city || address.town || address.village) {
                            addressHtml += `<div class="address-line"><i class="fas fa-city"></i> ${address.city || address.town || address.village}</div>`;
                        }
                        if (address.postcode) addressHtml += `<div class="address-line"><i class="fas fa-mail-bulk"></i> ${address.postcode}</div>`;
                        if (address.country) addressHtml += `<div class="address-line"><i class="fas fa-globe"></i> ${address.country}</div>`;
                        
                        addressDetails.innerHTML = addressHtml;
                        activityAddress = data.display_name;
                        activityAddressInput.value = activityAddress;
                        addressInfo.classList.add('show');
                        
                        showNotification("Adresse obtenue avec succ√®s!", "success");
                    } else {
                        addressDetails.innerHTML = '<p><i class="fas fa-exclamation-circle"></i> Adresse non trouv√©e pour ces coordonn√©es</p>';
                        addressInfo.classList.add('show');
                        showNotification("Adresse non trouv√©e pour ces coordonn√©es", "warning");
                    }
                })
                .catch(error => {
                    console.error("Erreur lors de la r√©cup√©ration de l'adresse:", error);
                    addressDetails.innerHTML = `<p><i class="fas fa-exclamation-triangle"></i> Erreur lors de la recherche de l'adresse</p>`;
                    addressInfo.classList.add('show');
                    showNotification("Erreur lors de la recherche de l'adresse", "error");
                });
        }
        
        // Fonction pour ins√©rer les coordonn√©es GPS dans les notes
        function insertGpsIntoNotes() {
            if (!activityLatitude || !activityLongitude) {
                showNotification("Veuillez d'abord obtenir la localisation GPS", "warning");
                return;
            }
            
            const timestamp = new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            const date = new Date().toLocaleDateString('fr-FR');
            
            let gpsNote = `<div style="background-color: #f8f9fa; padding: 15px; border-radius: 6px; margin: 10px 0; border-left: 4px solid #3498db;">
                <h4 style="margin-top: 0; color: #2c3e50;"><i class="fas fa-map-marked-alt"></i> Localisation de l'√©tude</h4>
                <p><strong>Date:</strong> ${date} √† ${timestamp}</p>
                <p><strong>Coordonn√©es GPS:</strong> ${activityLatitude.toFixed(6)}, ${activityLongitude.toFixed(6)}</p>`;
            
            if (activityAddress) {
                gpsNote += `<p><strong>Adresse:</strong> ${activityAddress}</p>`;
            }
            
            gpsNote += `<p><a href="https://maps.google.com/?q=${activityLatitude},${activityLongitude}" target="_blank" style="color: #3498db;">
                <i class="fas fa-external-link-alt"></i> Voir sur Google Maps
            </a></p></div>`;
            
            // Ajouter aux notes existantes
            const currentContent = richNotes.innerHTML;
            richNotes.innerHTML = currentContent + (currentContent ? '<br>' : '') + gpsNote;
            notesHiddenInput.value = richNotes.innerHTML;
            
            showNotification("Coordonn√©es GPS ins√©r√©es dans les notes!", "success");
        }
        
        // Obtenir la localisation au chargement de la page
        window.addEventListener('load', getLocation);
        
        // Boutons GPS pour le cahier d'activit√©
        getActivityLocationBtn.addEventListener('click', getActivityLocation);
        insertGpsBtn.addEventListener('click', insertGpsIntoNotes);
        getAddressBtn.addEventListener('click', function() {
            getAddressFromCoordinates(activityLatitude, activityLongitude);
        });
        
        // Bouton pour obtenir la localisation manuellement (formulaire principal)
        getLocationBtn.addEventListener('click', getLocation);
        
        // Fonction pour afficher une notification
        function showNotification(message, type = "info") {
            notification.textContent = message;
            
            // Changer la couleur selon le type
            if (type === "success") {
                notification.style.backgroundColor = "#27ae60";
            } else if (type === "error") {
                notification.style.backgroundColor = "#e74c3c";
            } else if (type === "warning") {
                notification.style.backgroundColor = "#f39c12";
            } else {
                notification.style.backgroundColor = "#3498db";
            }
            
            notification.style.display = "block";
            
            // Masquer apr√®s 5 secondes
            setTimeout(() => {
                notification.style.display = "none";
            }, 5000);
        }
        
        // Fonction pour exporter les donn√©es du formulaire courant au format JSON
        exportBtn.addEventListener('click', function() {
            // V√©rifier l'authentification
            if (!isAuthenticated) {
                showNotification("Veuillez vous connecter pour acc√©der √† cette fonctionnalit√©", "warning");
                return;
            }
            
            // R√©cup√©rer les donn√©es du formulaire
            const formData = new FormData(form);
            const data = {};
            
            // Convertir FormData en objet
            formData.forEach((value, key) => {
                data[key] = value;
            });
            
            // Ajouter les coordonn√©es GPS si disponibles
            if (userLatitude && userLongitude) {
                data.latitude = userLatitude;
                data.longitude = userLongitude;
            }
            
            // Ajouter un timestamp
            data.timestamp = new Date().toISOString();
            
            // Cr√©er un tableau avec les donn√©es (pour √™tre coh√©rent avec l'import)
            const exportData = [data];
            
            // Convertir en JSON
            const jsonData = JSON.stringify(exportData, null, 2);
            
            // Cr√©er un blob et un lien de t√©l√©chargement
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            // G√©n√©rer un nom de fichier avec la date
            const dateStr = new Date().toISOString().split('T')[0];
            a.download = `prechons_${dateStr}.json`;
            
            // D√©clencher le t√©l√©chargement
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification("Donn√©es du formulaire export√©es en JSON avec succ√®s!", "success");
        });
        
        // Fonction pour importer un fichier JSON
        importBtn.addEventListener('click', function() {
            // V√©rifier l'authentification
            if (!isAuthenticated) {
                showNotification("Veuillez vous connecter pour acc√©der √† cette fonctionnalit√©", "warning");
                return;
            }
            
            fileInput.click();
        });
        
        fileInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    importedData = JSON.parse(e.target.result);
                    lastImportedData = importedData; // Sauvegarder pour r√©f√©rence future
                    
                    // V√©rifier si c'est un tableau
                    if (!Array.isArray(importedData)) {
                        // Si c'est un objet unique, le convertir en tableau
                        importedData = [importedData];
                        lastImportedData = importedData;
                    }
                    
                    // CORRECTION : D√©tection am√©lior√©e des donn√©es import√©es
                    // D√©tecter le type de donn√©es avec plus de pr√©cision
                    const sampleItem = importedData[0] || {};
                    
                    // V√©rifier la pr√©sence de champs sp√©cifiques
                    const hasPreachingFields = sampleItem.hasOwnProperty('location') || sampleItem.hasOwnProperty('group');
                    const hasActivityFields = sampleItem.hasOwnProperty('personName') || sampleItem.hasOwnProperty('theme') || sampleItem.hasOwnProperty('nextVisitDate');
                    const hasCarteFields = sampleItem.hasOwnProperty('carteName') || sampleItem.hasOwnProperty('carteType') || sampleItem.hasOwnProperty('carteGroup');
                    
                    // D√©terminer le type de donn√©es
                    if (hasCarteFields) {
                        isCarteData = true;
                        isActivityData = false;
                    } else if (hasActivityFields && !hasPreachingFields) {
                        isActivityData = true;
                        isCarteData = false;
                    } else {
                        isActivityData = false;
                        isCarteData = false;
                    }
                    
                    // Ajouter un flag pour identifier les donn√©es import√©es
                    importedData.forEach((item, index) => {
                        item.imported = true;
                        item.id = Date.now() + Math.random() + index; // ID unique
                        
                        // Assurer que les champs n√©cessaires existent selon le type
                        if (isCarteData) {
                            if (!item.carteName) item.carteName = "Nom inconnu";
                            if (!item.carteType) item.carteType = "Non sp√©cifi√©";
                            if (!item.carteGroup) item.carteGroup = "Non sp√©cifi√©";
                            if (!item.carteCongregation) item.carteCongregation = "Non sp√©cifi√©e";
                            if (!item.cartePhone) item.cartePhone = "Non sp√©cifi√©";
                        } else if (isActivityData) {
                            if (!item.personName) item.personName = "Nom inconnu";
                            if (!item.theme) item.theme = "Non sp√©cifi√©";
                            if (!item.nextVisitDate) item.nextVisitDate = new Date().toISOString().split('T')[0];
                        } else {
                            if (!item.location) item.location = "Lieu inconnu";
                            if (!item.group) item.group = "Non sp√©cifi√©";
                            if (!item.date) item.date = new Date().toISOString().split('T')[0];
                        }
                    });
                    
                    if (isActivityData) {
                        // Ajouter aux activit√©s existantes
                        activities = [...activities, ...importedData];
                        
                        // Sauvegarder dans le localStorage
                        localStorage.setItem('activities', JSON.stringify(activities));
                        
                        // Mettre √† jour l'affichage
                        updateActivityList();
                        
                        // Afficher les options de chargement automatique
                        activityAutoLoadOptions.style.display = 'block';
                        updateJsonPreview(importedData, activityJsonPreview);
                        
                        // Basculer vers l'onglet cahier si la case est coch√©e
                        if (activityAutoLoadCheckbox.checked && importedData.length > 0) {
                            // Charger le premier √©l√©ment dans le formulaire
                            loadActivityFromImportedData(importedData[0]);
                            
                            // Basculer vers l'onglet cahier
                            tabs.forEach(t => t.classList.remove('active'));
                            tabContents.forEach(content => content.classList.remove('active'));
                            
                            document.querySelector('.tab[data-tab="cahier"]').classList.add('active');
                            document.getElementById('cahier-tab').classList.add('active');
                        }
                        
                        showNotification(`Fichier JSON d'activit√©s import√© avec succ√®s! ${importedData.length} entr√©es ajout√©es.`, "success");
                    } else if (isCarteData) {
                        // Ajouter aux cartes existantes
                        cartes = [...cartes, ...importedData];
                        
                        // Sauvegarder dans le localStorage
                        localStorage.setItem('cartes', JSON.stringify(cartes));
                        
                        // Mettre √† jour l'affichage
                        updateCarteList();
                        
                        // Afficher les options de chargement automatique
                        carteAutoLoadOptions.style.display = 'block';
                        updateCarteJsonPreview(importedData, carteJsonPreview);
                        
                        // Basculer vers l'onglet carte si la case est coch√©e
                        if (carteAutoLoadCheckbox.checked && importedData.length > 0) {
                            // Charger le premier √©l√©ment dans le formulaire
                            loadCarteFromImportedData(importedData[0]);
                            
                            // Basculer vers l'onglet carte
                            tabs.forEach(t => t.classList.remove('active'));
                            tabContents.forEach(content => content.classList.remove('active'));
                            
                            document.querySelector('.tab[data-tab="carte"]').classList.add('active');
                            document.getElementById('carte-tab').classList.add('active');
                        }
                        
                        showNotification(`Fichier JSON de cartes import√© avec succ√®s! ${importedData.length} entr√©es ajout√©es.`, "success");
                    } else {
                        // Ajouter aux pr√©dications existantes
                        preachings = [...preachings, ...importedData];
                        
                        // Sauvegarder dans le localStorage
                        localStorage.setItem('preachings', JSON.stringify(preachings));
                        
                        // Mettre √† jour l'affichage
                        updatePreachingList();
                        
                        // Afficher les options de chargement automatique
                        autoLoadOptions.style.display = 'block';
                        updateJsonPreview(importedData, jsonPreview);
                        
                        // Basculer vers l'onglet RDV si la case est coch√©e
                        if (autoLoadCheckbox.checked && importedData.length > 0) {
                            // Charger le premier √©l√©ment dans le formulaire
                            loadPreachingFromImportedData(importedData[0]);
                            
                            // Basculer vers l'onglet RDV
                            tabs.forEach(t => t.classList.remove('active'));
                            tabContents.forEach(content => content.classList.remove('active'));
                            
                            document.querySelector('.tab[data-tab="rdv"]').classList.add('active');
                            document.getElementById('rdv-tab').classList.add('active');
                        }
                        
                        showNotification(`Fichier JSON de pr√©dications import√© avec succ√®s! ${importedData.length} entr√©es ajout√©es.`, "success");
                    }
                    
                    updateStatistics();
                    
                } catch (error) {
                    console.error("Erreur lors de l'import du JSON:", error);
                    showNotification("Erreur: le fichier JSON est invalide.", "error");
                }
            };
            
            reader.readAsText(file);
            
            // R√©initialiser l'input file
            event.target.value = '';
        });
        
        // CORRECTION : Fonction de d√©tection am√©lior√©e pour √©viter les erreurs
        function detectDataType(data) {
            if (!data || typeof data !== 'object') return false;
            
            // V√©rifier la pr√©sence de champs sp√©cifiques aux activit√©s
            const activityFields = ['personName', 'theme', 'verse', 'nextVisitDate', 'nextVisitTime'];
            const hasActivityFields = activityFields.some(field => data.hasOwnProperty(field));
            
            // V√©rifier la pr√©sence de champs sp√©cifiques aux pr√©dications
            const preachingFields = ['location', 'group', 'neighborhood', 'preaching'];
            const hasPreachingFields = preachingFields.some(field => data.hasOwnProperty(field));
            
            // V√©rifier la pr√©sence de champs sp√©cifiques aux cartes
            const carteFields = ['carteName', 'carteType', 'carteGroup', 'carteCongregation'];
            const hasCarteFields = carteFields.some(field => data.hasOwnProperty(field));
            
            // Priorit√© : Carte > Activit√© > Pr√©dication
            if (hasCarteFields) {
                return 'carte';
            } else if (hasActivityFields && !hasPreachingFields) {
                return 'activity';
            } else if (hasPreachingFields && !hasActivityFields) {
                return 'preaching';
            }
            
            // Fallback : analyser les cl√©s disponibles
            const keys = Object.keys(data);
            if (keys.some(k => k.includes('carte'))) return 'carte';
            if (keys.some(k => k.includes('person') || k.includes('theme') || k.includes('visit'))) return 'activity';
            if (keys.some(k => k.includes('location') || k.includes('group') || k.includes('preach'))) return 'preaching';
            
            return 'unknown';
        }
        
        // Fonction pour mettre √† jour l'aper√ßu JSON
        function updateJsonPreview(data, previewElement) {
            if (!data || data.length === 0) {
                previewElement.innerHTML = '<p>Aucune donn√©e √† afficher</p>';
                return;
            }
            
            let previewHtml = `<p><strong>${data.length} √©l√©ment(s) import√©(s)</strong></p>`;
            
            // Afficher les premiers √©l√©ments (max 3)
            const itemsToShow = Math.min(data.length, 3);
            for (let i = 0; i < itemsToShow; i++) {
                const item = data[i];
                previewHtml += `<div style="margin-bottom: 10px; padding: 10px; background-color: white; border-radius: 4px; border-left: 3px solid #3498db;">`;
                
                if (isActivityData) {
                    previewHtml += `<strong>${item.personName || 'Sans nom'}</strong><br>`;
                    previewHtml += `<small>${item.theme || 'Sans th√®me'} - ${item.nextVisitDate || 'Pas de date'}</small>`;
                } else {
                    previewHtml += `<strong>${item.location || 'Sans lieu'}</strong><br>`;
                    previewHtml += `<small>${item.date || 'Pas de date'} - ${item.group || 'Pas de groupe'}</small>`;
                }
                
                previewHtml += `</div>`;
            }
            
            if (data.length > 3) {
                previewHtml += `<p>... et ${data.length - 3} autre(s) √©l√©ment(s)</p>`;
            }
            
            previewElement.innerHTML = previewHtml;
            previewElement.classList.add('show');
        }
        
        // Fonction pour mettre √† jour l'aper√ßu JSON des cartes
        function updateCarteJsonPreview(data, previewElement) {
            if (!data || data.length === 0) {
                previewElement.innerHTML = '<p>Aucune donn√©e √† afficher</p>';
                return;
            }
            
            let previewHtml = `<p><strong>${data.length} √©l√©ment(s) import√©(s)</strong></p>`;
            
            // Afficher les premiers √©l√©ments (max 3)
            const itemsToShow = Math.min(data.length, 3);
            for (let i = 0; i < itemsToShow; i++) {
                const item = data[i];
                previewHtml += `<div style="margin-bottom: 10px; padding: 10px; background-color: white; border-radius: 4px; border-left: 3px solid #e74c3c;">`;
                
                previewHtml += `<strong>${item.carteName || 'Sans nom'}</strong><br>`;
                previewHtml += `<small>${item.carteType || 'Non sp√©cifi√©'} - ${item.carteGroup || 'Pas de groupe'}</small>`;
                
                previewHtml += `</div>`;
            }
            
            if (data.length > 3) {
                previewHtml += `<p>... et ${data.length - 3} autre(s) √©l√©ment(s)</p>`;
            }
            
            previewElement.innerHTML = previewHtml;
            previewElement.classList.add('show');
        }
        
        // Fonction pour charger une pr√©dication √† partir des donn√©es import√©es
        function loadPreachingFromImportedData(data) {
            // Remplir le formulaire avec les donn√©es
            document.getElementById('date').value = data.date || '';
            document.getElementById('location').value = data.location || '';
            document.getElementById('group').value = data.group || '';
            document.getElementById('neighborhood').value = data.neighborhood || '';
            document.getElementById('preaching').value = data.preaching || '';
            
            // Mettre √† jour les coordonn√©es GPS si disponibles
            if (data.latitude && data.longitude) {
                userLatitude = data.latitude;
                userLongitude = data.longitude;
                
                latitudeElement.textContent = `Latitude: ${userLatitude.toFixed(6)}`;
                longitudeElement.textContent = `Longitude: ${userLongitude.toFixed(6)}`;
                gpsStatusElement.textContent = "Localisation charg√©e";
                gpsStatusElement.className = "gps-status active";
            }
            
            // Activer le mode √©dition
            editingIdInput.value = data.id;
            formMode.style.display = 'block';
            formMode.classList.add('edit-mode');
            formTitle.textContent = 'Modifier une pr√©dication import√©e';
            cancelEditBtn.style.display = 'flex';
            document.getElementById('saveBtn').innerHTML = '<i class="fas fa-save"></i> Mettre √† jour';
            
            showNotification("Premi√®re pr√©dication import√©e charg√©e dans le formulaire. Modifiez et cliquez sur 'Mettre √† jour'.", "success");
        }
        
        // Fonction pour charger une activit√© √† partir des donn√©es import√©es
        function loadActivityFromImportedData(data) {
            // Remplir le formulaire avec les donn√©es de l'activit√©
            document.getElementById('personName').value = data.personName || '';
            document.getElementById('theme').value = data.theme || '';
            document.getElementById('verse').value = data.verse || '';
            document.getElementById('suspendedTheme').value = data.suspendedTheme || '';
            document.getElementById('nextVisitDate').value = data.nextVisitDate || '';
            document.getElementById('nextVisitTime').value = data.nextVisitTime || '';
            
            // Remplir les donn√©es GPS si disponibles
            if (data.latitude && data.longitude) {
                activityLatitude = data.latitude;
                activityLongitude = data.longitude;
                activityAddress = data.address || '';
                
                activityLatitudeElement.textContent = activityLatitude.toFixed(6);
                activityLongitudeElement.textContent = activityLongitude.toFixed(6);
                activityLatitudeInput.value = activityLatitude;
                activityLongitudeInput.value = activityLongitude;
                activityAddressInput.value = activityAddress;
                
                activityGpsInfo.innerHTML = `
                    <p><i class="fas fa-check-circle" style="color: #27ae60;"></i> Localisation import√©e</p>
                    <div class="coordinates-display">
                        <div class="coordinate-item">
                            <strong>Latitude:</strong> ${activityLatitude.toFixed(6)}
                        </div>
                        <div class="coordinate-item">
                            <strong>Longitude:</strong> ${activityLongitude.toFixed(6)}
                        </div>
                    </div>
                `;
                
                if (data.address) {
                    addressDetails.innerHTML = `
                        <div class="address-line"><i class="fas fa-address-card"></i> ${data.address}</div>
                    `;
                    addressInfo.classList.add('show');
                }
            }
            
            // Remplir l'√©diteur enrichi
            richNotes.innerHTML = data.notes || '';
            notesHiddenInput.value = data.notes || '';
            
            // Activer le mode √©dition
            editingActivityIdInput.value = data.id;
            activityFormMode.style.display = 'block';
            activityFormMode.classList.add('edit-mode');
            activityFormTitle.textContent = 'Modifier une activit√© import√©e';
            cancelActivityEditBtn.style.display = 'flex';
            document.getElementById('saveActivityBtn').innerHTML = '<i class="fas fa-save"></i> Mettre √† jour';
            
            showNotification("Premi√®re activit√© import√©e charg√©e dans le formulaire. Modifiez et cliquez sur 'Mettre √† jour'.", "success");
        }
        
        // Fonction pour charger une carte √† partir des donn√©es import√©es
        function loadCarteFromImportedData(data) {
            // Remplir le formulaire avec les donn√©es de la carte
            document.getElementById('carteName').value = data.carteName || '';
            document.getElementById('carteType').value = data.carteType || '';
            document.getElementById('carteGroup').value = data.carteGroup || '';
            document.getElementById('carteCongregation').value = data.carteCongregation || '';
            document.getElementById('cartePhone').value = data.cartePhone || '';
            document.getElementById('carteWhatsApp').value = data.carteWhatsApp || '';
            document.getElementById('carteAddress').value = data.carteAddress || '';
            document.getElementById('carteNotes').value = data.carteNotes || '';
            
            // Mettre √† jour les coordonn√©es GPS si disponibles
            if (data.latitude && data.longitude) {
                carteLatitude = data.latitude;
                carteLongitude = data.longitude;
                
                carteLatitudeElement.textContent = `Latitude: ${carteLatitude.toFixed(6)}`;
                carteLongitudeElement.textContent = `Longitude: ${carteLongitude.toFixed(6)}`;
                carteGpsStatusElement.textContent = "Localisation charg√©e";
                carteGpsStatusElement.className = "gps-status active";
            }
            
            // Activer le mode √©dition
            editingCarteIdInput.value = data.id;
            carteFormMode.style.display = 'block';
            carteFormMode.classList.add('edit-mode');
            carteFormTitle.textContent = 'Modifier une fiche import√©e';
            cancelCarteEditBtn.style.display = 'flex';
            document.getElementById('saveCarteBtn').innerHTML = '<i class="fas fa-save"></i> Mettre √† jour';
            
            showNotification("Premi√®re fiche import√©e charg√©e dans le formulaire. Modifiez et cliquez sur 'Mettre √† jour'.", "success");
        }
        
        // Bouton pour charger le premier √©l√©ment import√©
        loadFirstBtn.addEventListener('click', function() {
            if (lastImportedData && lastImportedData.length > 0 && !isActivityData && !isCarteData) {
                loadPreachingFromImportedData(lastImportedData[0]);
            } else {
                showNotification("Aucune donn√©e de pr√©dication import√©e √† charger", "warning");
            }
        });
        
        // Bouton pour charger le premier √©l√©ment d'activit√© import√©
        activityLoadFirstBtn.addEventListener('click', function() {
            if (lastImportedData && lastImportedData.length > 0 && isActivityData) {
                loadActivityFromImportedData(lastImportedData[0]);
            } else {
                showNotification("Aucune donn√©e d'activit√© import√©e √† charger", "warning");
            }
        });
        
        // Bouton pour voir tous les √©l√©ments import√©s
        loadAllBtn.addEventListener('click', function() {
            if (lastImportedData && lastImportedData.length > 0 && !isActivityData && !isCarteData) {
                // Basculer vers l'onglet liste
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));
                
                document.querySelector('.tab[data-tab="liste"]').classList.add('active');
                document.getElementById('liste-tab').classList.add('active');
                
                showNotification(`Affichage de ${lastImportedData.length} pr√©dications import√©es dans la liste`, "info");
            } else {
                showNotification("Aucune donn√©e de pr√©dication import√©e √† afficher", "warning");
            }
        });
        
        // Bouton pour voir tous les √©l√©ments d'activit√© import√©s
        activityLoadAllBtn.addEventListener('click', function() {
            if (lastImportedData && lastImportedData.length > 0 && isActivityData) {
                // L'onglet cahier affiche d√©j√† les activit√©s
                showNotification(`${lastImportedData.length} activit√©s import√©es ajout√©es √† la liste`, "info");
            } else {
                showNotification("Aucune donn√©e d'activit√© import√©e √† afficher", "warning");
            }
        });
        
        // Fonction pour envoyer via WhatsApp
        whatsappBtn.addEventListener('click', function() {
            // V√©rifier l'authentification
            if (!isAuthenticated) {
                showNotification("Veuillez vous connecter pour acc√©der √† cette fonctionnalit√©", "warning");
                return;
            }
            
            // R√©cup√©rer les donn√©es du formulaire
            const formData = new FormData(form);
            const data = {};
            
            // Convertir FormData en objet
            formData.forEach((value, key) => {
                data[key] = value;
            });
            
            // V√©rifier que les champs obligatoires sont remplis
            if (!data.date || !data.location || !data.group || !data.neighborhood) {
                showNotification("Veuillez remplir tous les champs obligatoires avant d'envoyer.", "warning");
                return;
            }
            
            // Cr√©er le message WhatsApp
            let message = `*NOUVELLE PR√âDICATION ENREGISTR√âE*\n\n`;
            message += `üìÖ *Date:* ${data.date}\n`;
            message += `üìç *Lieu:* ${data.location}\n`;
            message += `üë• *Groupe:* ${data.group}\n`;
            message += `üèòÔ∏è *Quartier:* ${data.neighborhood}\n`;
            
            if (data.preaching) {
                message += `üìñ *Pr√©dication:* ${data.preaching}\n`;
            }
            
            if (userLatitude && userLongitude) {
                message += `üó∫Ô∏è *Coordonn√©es GPS:* ${userLatitude.toFixed(6)}, ${userLongitude.toFixed(6)}\n`;
                message += `https://maps.google.com/?q=${userLatitude},${userLongitude}`;
            }
            
            message += `\n_Enregistr√© via l'application Pr√™chons_`;
            
            // Encoder le message pour l'URL
            const encodedMessage = encodeURIComponent(message);
            
            // Num√©ro WhatsApp (+228 92871605)
            const phoneNumber = "+22892871605";
            
            // Cr√©er l'URL WhatsApp
            const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
            
            // Ouvrir WhatsApp dans une nouvelle fen√™tre
            window.open(whatsappUrl, '_blank');
            
            showNotification("Pr√©paration du message WhatsApp...", "success");
        });
        
        // Gestion de la soumission du formulaire de pr√©dication
        form.addEventListener('submit', function(event) {
            event.preventDefault();
            
            // V√©rifier l'authentification
            if (!isAuthenticated) {
                showNotification("Veuillez vous connecter pour acc√©der √† cette fonctionnalit√©", "warning");
                return;
            }
            
            // R√©cup√©rer les donn√©es du formulaire
            const formData = new FormData(form);
            const data = {};
            
            // Convertir FormData en objet
            formData.forEach((value, key) => {
                data[key] = value;
            });
            
            // Ajouter les coordonn√©es GPS
            data.latitude = userLatitude;
            data.longitude = userLongitude;
            data.timestamp = new Date().toISOString();
            
            // V√©rifier si on est en mode √©dition
            const editingId = editingIdInput.value;
            if (editingId) {
                // Mode √©dition: mettre √† jour l'existant
                data.id = editingId;
                
                // Trouver l'index de la pr√©dication
                const index = preachings.findIndex(p => p.id == editingId);
                
                if (index !== -1) {
                    // Conserver les donn√©es existantes si non modifi√©es
                    preachings[index] = {...preachings[index], ...data};
                    showNotification("Pr√©dication modifi√©e avec succ√®s!", "success");
                }
                
                // Quitter le mode √©dition
                cancelEdit();
            } else {
                // Mode cr√©ation: ajouter une nouvelle pr√©dication
                data.id = Date.now(); // ID unique
                
                // Ajouter √† la liste des pr√©dications
                preachings.push(data);
                showNotification("Pr√©dication enregistr√©e avec succ√®s!", "success");
            }
            
            // Sauvegarder dans le localStorage
            localStorage.setItem('preachings', JSON.stringify(preachings));
            
            // Mettre √† jour l'affichage
            updatePreachingList();
            updateStatistics();
            
            // R√©initialiser le formulaire
            if (!editingId) {
                form.reset();
                
                // R√©initialiser la date √† aujourd'hui
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('date').value = today;
            }
        });
        
        // Gestion de la soumission du formulaire d'activit√©
        activityForm.addEventListener('submit', function(event) {
            event.preventDefault();
            
            // R√©cup√©rer les donn√©es du formulaire
            const formData = new FormData(activityForm);
            const data = {};
            
            // Convertir FormData en objet
            formData.forEach((value, key) => {
                data[key] = value;
            });
            
            // Ajouter le contenu HTML des notes
            data.notes = notesHiddenInput.value;
            
            // Ajouter les coordonn√©es GPS si disponibles
            if (activityLatitude && activityLongitude) {
                data.latitude = activityLatitude;
                data.longitude = activityLongitude;
                data.address = activityAddressInput.value;
            }
            
            // Ajouter des m√©tadonn√©es
            data.createdAt = new Date().toISOString();
            data.status = 'pending'; // pending, completed
            
            // V√©rifier si on est en mode √©dition
            const editingActivityId = editingActivityIdInput.value;
            if (editingActivityId) {
                // Mode √©dition: mettre √† jour l'existant
                data.id = editingActivityId;
                
                // Trouver l'index de l'activit√©
                const index = activities.findIndex(a => a.id == editingActivityId);
                
                if (index !== -1) {
                    // Conserver les donn√©es existantes si non modifi√©es
                    activities[index] = {...activities[index], ...data};
                    showNotification("Activit√© modifi√©e avec succ√®s!", "success");
                }
                
                // Quitter le mode √©dition
                cancelActivityEdit();
            } else {
                // Mode cr√©ation: ajouter une nouvelle activit√©
                data.id = Date.now(); // ID unique
                
                // Ajouter √† la liste des activit√©s
                activities.push(data);
                showNotification("Activit√© ajout√©e au cahier avec succ√®s!", "success");
            }
            
            // Sauvegarder dans le localStorage
            localStorage.setItem('activities', JSON.stringify(activities));
            
            // Mettre √† jour l'affichage
            updateActivityList();
            updateStatistics();
            
            // R√©initialiser le formulaire si pas en mode √©dition
            if (!editingActivityId) {
                resetActivityForm();
            }
        });
        
        // Fonction pour r√©initialiser le formulaire d'activit√©
        function resetActivityForm() {
            activityForm.reset();
            richNotes.innerHTML = '';
            notesHiddenInput.value = '';
            activityGpsInfo.innerHTML = '<p>Cliquez sur "Obtenir la localisation" pour capturer les coordonn√©es GPS actuelles.</p>';
            addressInfo.classList.remove('show');
            activityLatitude = null;
            activityLongitude = null;
            activityAddress = null;
            activityLatitudeInput.value = '';
            activityLongitudeInput.value = '';
            activityAddressInput.value = '';
            
            // D√©finir les valeurs par d√©faut
            const nextWeek = new Date();
            nextWeek.setDate(nextWeek.getDate() + 7);
            const nextWeekFormatted = nextWeek.toISOString().split('T')[0];
            document.getElementById('nextVisitDate').value = nextWeekFormatted;
            document.getElementById('nextVisitTime').value = '10:00';
        }
        
        // Bouton pour effacer le formulaire d'activit√©
        clearActivityFormBtn.addEventListener('click', function() {
            resetActivityForm();
            showNotification("Formulaire effac√©", "info");
        });
        
        // Fonction pour annuler l'√©dition dans le formulaire
        cancelEditBtn.addEventListener('click', cancelEdit);
        
        function cancelEdit() {
            editingIdInput.value = '';
            formMode.style.display = 'none';
            formMode.classList.remove('edit-mode');
            formTitle.textContent = 'Nouvelle pr√©dication';
            cancelEditBtn.style.display = 'none';
            document.getElementById('saveBtn').innerHTML = '<i class="fas fa-save"></i> Enregistrer';
            
            // R√©initialiser le formulaire
            form.reset();
            
            // R√©initialiser la date √† aujourd'hui
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
            
            showNotification("Mode √©dition annul√©", "info");
        }
        
        // Fonction pour annuler l'√©dition d'activit√© dans le formulaire
        cancelActivityEditBtn.addEventListener('click', cancelActivityEdit);
        
        function cancelActivityEdit() {
            editingActivityIdInput.value = '';
            activityFormMode.style.display = 'none';
            activityFormMode.classList.remove('edit-mode');
            activityFormTitle.textContent = 'Nouvelle entr√©e dans le cahier d\'activit√©';
            cancelActivityEditBtn.style.display = 'none';
            document.getElementById('saveActivityBtn').innerHTML = '<i class="fas fa-save"></i> Ajouter au cahier';
            
            // R√©initialiser le formulaire
            resetActivityForm();
            
            showNotification("Mode √©dition annul√©", "info");
        }
        
        // Fonction pour annuler l'√©dition de carte dans le formulaire
        cancelCarteEditBtn.addEventListener('click', cancelCarteEdit);
        
        function cancelCarteEdit() {
            editingCarteIdInput.value = '';
            carteFormMode.style.display = 'none';
            carteFormMode.classList.remove('edit-mode');
            carteFormTitle.textContent = 'Nouvelle fiche fr√®re/s≈ìur';
            cancelCarteEditBtn.style.display = 'none';
            document.getElementById('saveCarteBtn').innerHTML = '<i class="fas fa-save"></i> Enregistrer';
            
            // R√©initialiser le formulaire
            carteForm.reset();
            
            showNotification("Mode √©dition annul√©", "info");
        }
        
        // Fonction pour mettre √† jour la liste des pr√©dications
        function updatePreachingList() {
            if (preachings.length === 0) {
                preachingList.innerHTML = `
                    <div class="empty-list">
                        <i class="fas fa-calendar-times"></i>
                        <h3>Aucune pr√©dication enregistr√©e</h3>
                        <p>Ajoutez votre premi√®re pr√©dication dans l'onglet "RDV"</p>
                    </div>
                `;
                return;
            }
            
            // Trier par date (la plus r√©cente en premier)
            const sortedPreachings = [...preachings].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // G√©n√©rer le HTML pour chaque pr√©dication
            preachingList.innerHTML = sortedPreachings.map(preaching => {
                const isImported = preaching.imported || false;
                
                return `
                    <div class="list-item" data-id="${preaching.id}">
                        <div class="list-item-header">
                            <div class="list-date">
                                <i class="fas fa-calendar-alt"></i> ${preaching.date}
                                ${isImported ? '<span class="imported-badge">Import√©</span>' : ''}
                            </div>
                            <div class="list-location">
                                <i class="fas fa-map-marker-alt"></i> ${preaching.location}
                            </div>
                        </div>
                        <div>
                            <strong>Quartier:</strong> ${preaching.neighborhood}
                        </div>
                        <div class="list-group">
                            <i class="fas fa-users"></i> ${preaching.group}
                        </div>
                        ${preaching.preaching ? `<div style="margin-top: 10px;"><strong>Notes:</strong> ${preaching.preaching}</div>` : ''}
                        ${preaching.latitude ? `<div style="margin-top: 5px; font-size: 0.9rem; color: #64748b;"><i class="fas fa-map-pin"></i> ${preaching.latitude.toFixed(4)}, ${preaching.longitude.toFixed(4)}</div>` : ''}
                        
                        <div class="edit-actions">
                            <button class="btn-load-form" onclick="loadPreachingToForm('${preaching.id}')">
                                <i class="fas fa-edit"></i> Charger dans le formulaire
                            </button>
                            <button class="btn-delete" onclick="deletePreaching('${preaching.id}')">
                                <i class="fas fa-trash"></i> Supprimer
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Fonction pour charger une pr√©dication dans le formulaire
        window.loadPreachingToForm = function(id) {
            // V√©rifier l'authentification
            if (!isAuthenticated) {
                showNotification("Veuillez vous connecter pour acc√©der √† cette fonctionnalit√©", "warning");
                return;
            }
            
            const preaching = preachings.find(p => p.id == id);
            if (!preaching) return;
            
            // Remplir le formulaire avec les donn√©es
            document.getElementById('date').value = preaching.date || '';
            document.getElementById('location').value = preaching.location || '';
            document.getElementById('group').value = preaching.group || '';
            document.getElementById('neighborhood').value = preaching.neighborhood || '';
            document.getElementById('preaching').value = preaching.preaching || '';
            
            // Mettre √† jour les coordonn√©es GPS si disponibles
            if (preaching.latitude && preaching.longitude) {
                userLatitude = preaching.latitude;
                userLongitude = preaching.longitude;
                
                latitudeElement.textContent = `Latitude: ${userLatitude.toFixed(6)}`;
                longitudeElement.textContent = `Longitude: ${userLongitude.toFixed(6)}`;
                gpsStatusElement.textContent = "Localisation charg√©e";
                gpsStatusElement.className = "gps-status active";
            }
            
            // Activer le mode √©dition
            editingIdInput.value = id;
            formMode.style.display = 'block';
            formMode.classList.add('edit-mode');
            formTitle.textContent = 'Modifier une pr√©dication';
            cancelEditBtn.style.display = 'flex';
            document.getElementById('saveBtn').innerHTML = '<i class="fas fa-save"></i> Mettre √† jour';
            
            // Basculer vers l'onglet RDV
            tabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            
            document.querySelector('.tab[data-tab="rdv"]').classList.add('active');
            document.getElementById('rdv-tab').classList.add('active');
            
            showNotification("Pr√©dication charg√©e dans le formulaire. Modifiez et cliquez sur 'Mettre √† jour'.", "success");
        };
        
        // Fonction pour supprimer une pr√©dication
        window.deletePreaching = function(id) {
            // V√©rifier l'authentification
            if (!isAuthenticated) {
                showNotification("Veuillez vous connecter pour acc√©der √† cette fonctionnalit√©", "warning");
                return;
            }
            
            if (confirm("Voulez-vous vraiment supprimer cette pr√©dication ?")) {
                // Supprimer de la liste
                preachings = preachings.filter(p => p.id != id);
                
                // Sauvegarder dans le localStorage
                localStorage.setItem('preachings', JSON.stringify(preachings));
                
                // Mettre √† jour l'affichage
                updatePreachingList();
                updateStatistics();
                
                showNotification("Pr√©dication supprim√©e", "success");
            }
        };
        
        // Fonction pour mettre √† jour la liste des activit√©s
        function updateActivityList() {
            if (activities.length === 0) {
                activityList.innerHTML = `
                    <div class="empty-list">
                        <i class="fas fa-book-open"></i>
                        <h3>Cahier d'activit√© vide</h3>
                        <p>Ajoutez votre premi√®re entr√©e pour commencer √† suivre vos activit√©s</p>
                    </div>
                `;
                return;
            }
            
            // Trier par date de visite (la plus proche en premier)
            const sortedActivities = [...activities].sort((a, b) => new Date(a.nextVisitDate) - new Date(b.nextVisitDate));
            
            // G√©n√©rer le HTML pour chaque activit√©
            activityList.innerHTML = sortedActivities.map(activity => {
                // V√©rifier si la visite est pass√©e
                const visitDate = new Date(`${activity.nextVisitDate}T${activity.nextVisitTime}`);
                const now = new Date();
                const isPast = visitDate < now;
                const statusClass = isPast ? 'status-pending' : 'status-pending';
                const statusText = isPast ? 'En attente' : '√Ä venir';
                const isImported = activity.imported || false;
                
                return `
                    <div class="activity-item">
                        <div class="activity-item-header">
                            <div class="activity-person">
                                <i class="fas fa-user"></i> ${activity.personName}
                                <span class="status-badge ${statusClass}">${statusText}</span>
                                ${isImported ? '<span class="imported-badge">Import√©</span>' : ''}
                            </div>
                            <div class="activity-date">
                                <i class="fas fa-calendar"></i> ${activity.nextVisitDate}
                            </div>
                        </div>
                        
                        <div class="activity-theme">
                            <i class="fas fa-book-open"></i> <strong>Th√®me:</strong> ${activity.theme}
                        </div>
                        
                        ${activity.verse ? `
                        <div class="activity-verse">
                            <i class="fas fa-bible"></i> <strong>Verset/Publication:</strong> ${activity.verse}
                        </div>
                        ` : ''}
                        
                        ${activity.suspendedTheme ? `
                        <div class="activity-suspended">
                            <i class="fas fa-pause-circle"></i> <strong>Th√®me en suspens:</strong> ${activity.suspendedTheme}
                        </div>
                        ` : ''}
                        
                        ${activity.latitude && activity.longitude ? `
                        <div style="margin-top: 10px; color: #64748b;">
                            <i class="fas fa-map-marked-alt"></i> <strong>Localisation:</strong> 
                            <div style="margin-top: 5px; padding: 10px; background-color: #f8f9fa; border-radius: 4px; font-size: 0.9em;">
                                ${activity.latitude.toFixed(6)}, ${activity.longitude.toFixed(6)}
                                ${activity.address ? `<br><small>${activity.address}</small>` : ''}
                            </div>
                        </div>
                        ` : ''}
                        
                        ${activity.notes ? `
                        <div style="margin-top: 10px; color: #64748b;">
                            <i class="fas fa-sticky-note"></i> <strong>Notes:</strong> 
                            <div style="margin-top: 5px; padding: 10px; background-color: #f8f9fa; border-radius: 4px;">
                                ${activity.notes}
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="activity-next-visit">
                            <div>
                                <i class="fas fa-clock"></i> Prochaine visite: ${activity.nextVisitDate} √† ${activity.nextVisitTime}
                            </div>
                        </div>
                        
                        <div class="activity-actions">
                            <button class="btn-load-form" onclick="loadActivityToForm(${activity.id})">
                                <i class="fas fa-edit"></i> Charger dans le formulaire
                            </button>
                            <button class="btn-delete" onclick="deleteActivity(${activity.id})">
                                <i class="fas fa-trash"></i> Supprimer
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Fonction pour charger une activit√© dans le formulaire
        window.loadActivityToForm = function(id) {
            const activity = activities.find(a => a.id === id);
            if (!activity) return;
            
            // Remplir le formulaire avec les donn√©es de l'activit√©
            document.getElementById('personName').value = activity.personName || '';
            document.getElementById('theme').value = activity.theme || '';
            document.getElementById('verse').value = activity.verse || '';
            document.getElementById('suspendedTheme').value = activity.suspendedTheme || '';
            document.getElementById('nextVisitDate').value = activity.nextVisitDate || '';
            document.getElementById('nextVisitTime').value = activity.nextVisitTime || '';
            
            // Remplir les donn√©es GPS si disponibles
            if (activity.latitude && activity.longitude) {
                activityLatitude = activity.latitude;
                activityLongitude = activity.longitude;
                activityAddress = activity.address || '';
                
                activityLatitudeElement.textContent = activityLatitude.toFixed(6);
                activityLongitudeElement.textContent = activityLongitude.toFixed(6);
                activityLatitudeInput.value = activityLatitude;
                activityLongitudeInput.value = activityLongitude;
                activityAddressInput.value = activityAddress;
                
                activityGpsInfo.innerHTML = `
                    <p><i class="fas fa-check-circle" style="color: #27ae60;"></i> Localisation d√©j√† enregistr√©e</p>
                    <div class="coordinates-display">
                        <div class="coordinate-item">
                            <strong>Latitude:</strong> ${activityLatitude.toFixed(6)}
                        </div>
                        <div class="coordinate-item">
                            <strong>Longitude:</strong> ${activityLongitude.toFixed(6)}
                        </div>
                    </div>
                `;
                
                if (activity.address) {
                    addressDetails.innerHTML = `
                        <div class="address-line"><i class="fas fa-address-card"></i> ${activity.address}</div>
                    `;
                    addressInfo.classList.add('show');
                }
            }
            
            // Remplir l'√©diteur enrichi
            richNotes.innerHTML = activity.notes || '';
            notesHiddenInput.value = activity.notes || '';
            
            // Activer le mode √©dition
            editingActivityIdInput.value = activity.id;
            activityFormMode.style.display = 'block';
            activityFormMode.classList.add('edit-mode');
            activityFormTitle.textContent = 'Modifier une activit√©';
            cancelActivityEditBtn.style.display = 'flex';
            document.getElementById('saveActivityBtn').innerHTML = '<i class="fas fa-save"></i> Mettre √† jour';
            
            // Basculer vers l'onglet cahier
            tabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            
            document.querySelector('.tab[data-tab="cahier"]').classList.add('active');
            document.getElementById('cahier-tab').classList.add('active');
            
            showNotification("Activit√© charg√©e dans le formulaire. Modifiez et cliquez sur 'Mettre √† jour'.", "success");
        };
        
        // Fonction pour supprimer une activit√©
        window.deleteActivity = function(id) {
            if (confirm("Voulez-vous vraiment supprimer cette activit√© ?")) {
                activities = activities.filter(a => a.id !== id);
                localStorage.setItem('activities', JSON.stringify(activities));
                updateActivityList();
                updateStatistics();
                showNotification("Activit√© supprim√©e", "success");
            }
        };
        
        // Fonction pour mettre √† jour la liste des cartes
        function updateCarteList() {
            if (cartes.length === 0) {
                carteList.innerHTML = `
                    <div class="empty-list">
                        <i class="fas fa-map"></i>
                        <h3>Aucune fiche enregistr√©e</h3>
                        <p>Ajoutez votre premi√®re fiche fr√®re/s≈ìur pour commencer</p>
                    </div>
                `;
                return;
            }
            
            // Trier par nom
            const sortedCartes = [...cartes].sort((a, b) => (a.carteName || '').localeCompare(b.carteName || ''));
            
            // G√©n√©rer le HTML pour chaque carte
            carteList.innerHTML = sortedCartes.map(carte => {
                const isImported = carte.imported || false;
                
                return `
                    <div class="carte-item">
                        <div class="carte-item-header">
                            <div class="carte-name">
                                <i class="fas fa-user"></i> ${carte.carteName || 'Sans nom'}
                                ${isImported ? '<span class="imported-badge">Import√©</span>' : ''}
                            </div>
                            <div class="carte-group">
                                <i class="fas fa-users"></i> ${carte.carteGroup || 'Non sp√©cifi√©'}
                            </div>
                        </div>
                        
                        <div class="carte-congregation">
                            <i class="fas fa-church"></i> <strong>Congr√©gation:</strong> ${carte.carteCongregation || 'Non sp√©cifi√©e'}
                        </div>
                        
                        <div class="carte-contact">
                            <i class="fas fa-user-tag"></i> <strong>Statut:</strong> ${carte.carteType || 'Non sp√©cifi√©'}
                        </div>
                        
                        <div class="carte-contact">
                            <i class="fas fa-phone"></i> <strong>T√©l√©phone:</strong> 
                            <span class="phone-contact">${carte.cartePhone || 'Non sp√©cifi√©'}</span>
                        </div>
                        
                        ${carte.carteWhatsApp ? `
                        <div class="carte-contact">
                            <i class="fab fa-whatsapp"></i> <strong>WhatsApp:</strong> 
                            <span class="whatsapp-contact">${carte.carteWhatsApp}</span>
                        </div>
                        ` : ''}
                        
                        ${carte.carteAddress ? `
                        <div class="carte-address">
                            <i class="fas fa-map-marker-alt"></i> <strong>Adresse:</strong> ${carte.carteAddress}
                        </div>
                        ` : ''}
                        
                        ${carte.latitude && carte.longitude ? `
                        <div style="margin-top: 10px; color: #64748b;">
                            <i class="fas fa-map-marked-alt"></i> <strong>Localisation:</strong> 
                            <div style="margin-top: 5px; padding: 10px; background-color: #f8f9fa; border-radius: 4px; font-size: 0.9em;">
                                ${carte.latitude.toFixed(6)}, ${carte.longitude.toFixed(6)}
                            </div>
                        </div>
                        ` : ''}
                        
                        ${carte.carteNotes ? `
                        <div style="margin-top: 10px; color: #64748b;">
                            <i class="fas fa-sticky-note"></i> <strong>Notes:</strong> 
                            <div style="margin-top: 5px; padding: 10px; background-color: #f8f9fa; border-radius: 4px;">
                                ${carte.carteNotes}
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="carte-actions">
                            <button class="btn-load-form" onclick="loadCarteToForm(${carte.id})">
                                <i class="fas fa-edit"></i> Charger dans le formulaire
                            </button>
                            <button class="btn-delete" onclick="deleteCarte(${carte.id})">
                                <i class="fas fa-trash"></i> Supprimer
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Fonction pour charger une carte dans le formulaire
        window.loadCarteToForm = function(id) {
            const carte = cartes.find(c => c.id === id);
            if (!carte) return;
            
            // Remplir le formulaire avec les donn√©es de la carte
            document.getElementById('carteName').value = carte.carteName || '';
            document.getElementById('carteType').value = carte.carteType || '';
            document.getElementById('carteGroup').value = carte.carteGroup || '';
            document.getElementById('carteCongregation').value = carte.carteCongregation || '';
            document.getElementById('cartePhone').value = carte.cartePhone || '';
            document.getElementById('carteWhatsApp').value = carte.carteWhatsApp || '';
            document.getElementById('carteAddress').value = carte.carteAddress || '';
            document.getElementById('carteNotes').value = carte.carteNotes || '';
            
            // Mettre √† jour les coordonn√©es GPS si disponibles
            if (carte.latitude && carte.longitude) {
                carteLatitude = carte.latitude;
                carteLongitude = carte.longitude;
                
                carteLatitudeElement.textContent = `Latitude: ${carteLatitude.toFixed(6)}`;
                carteLongitudeElement.textContent = `Longitude: ${carteLongitude.toFixed(6)}`;
                carteGpsStatusElement.textContent = "Localisation charg√©e";
                carteGpsStatusElement.className = "gps-status active";
            }
            
            // Activer le mode √©dition
            editingCarteIdInput.value = carte.id;
            carteFormMode.style.display = 'block';
            carteFormMode.classList.add('edit-mode');
            carteFormTitle.textContent = 'Modifier une fiche';
            cancelCarteEditBtn.style.display = 'flex';
            document.getElementById('saveCarteBtn').innerHTML = '<i class="fas fa-save"></i> Mettre √† jour';
            
            // Basculer vers l'onglet carte
            tabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            
            document.querySelector('.tab[data-tab="carte"]').classList.add('active');
            document.getElementById('carte-tab').classList.add('active');
            
            showNotification("Fiche charg√©e dans le formulaire. Modifiez et cliquez sur 'Mettre √† jour'.", "success");
        };
        
        // Fonction pour supprimer une carte
        window.deleteCarte = function(id) {
            if (confirm("Voulez-vous vraiment supprimer cette fiche ?")) {
                cartes = cartes.filter(c => c.id !== id);
                localStorage.setItem('cartes', JSON.stringify(cartes));
                updateCarteList();
                showNotification("Fiche supprim√©e", "success");
            }
        };
        
        // Fonction pour mettre √† jour les statistiques
        function updateStatistics() {
            // Total des pr√©dications
            document.getElementById('totalPreachings').textContent = preachings.length;
            
            // Groupes actifs (groupes uniques)
            const uniqueGroups = [...new Set(preachings.map(p => p.group))].filter(g => g);
            document.getElementById('activeGroups').textContent = uniqueGroups.length;
            
            // Lieux diff√©rents
            const uniqueLocations = [...new Set(preachings.map(p => p.location))].filter(l => l);
            document.getElementById('differentLocations').textContent = uniqueLocations.length;
            
            // Total des activit√©s
            document.getElementById('totalActivities').textContent = activities.length;
            
            // R√©partition par groupe
            const groupDistribution = document.getElementById('groupDistribution');
            
            if (preachings.length === 0) {
                groupDistribution.innerHTML = `<p style="color: #64748b; text-align: center;">Aucune donn√©e disponible</p>`;
                return;
            }
            
            // Compter les pr√©dications par groupe
            const groupCounts = {};
            preachings.forEach(p => {
                if (p.group) {
                    groupCounts[p.group] = (groupCounts[p.group] || 0) + 1;
                }
            });
            
            // Cr√©er les barres de r√©partition
            groupDistribution.innerHTML = Object.entries(groupCounts).map(([group, count]) => {
                const percentage = (count / preachings.length * 100).toFixed(1);
                return `
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>${group}</span>
                            <span>${count} (${percentage}%)</span>
                        </div>
                        <div style="background-color: #e2e8f0; height: 10px; border-radius: 5px; overflow: hidden;">
                            <div style="background-color: #3498db; height: 100%; width: ${percentage}%; border-radius: 5px;"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Ajouter l'animation de secousse pour l'erreur d'authentification
        const style = document.createElement('style');
        style.textContent = `
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
                20%, 40%, 60%, 80% { transform: translateX(5px); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
